<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/hexo-test/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/hexo-test/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hexo-test/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/hexo-test/images/logo.svg" color="#222">

<link rel="stylesheet" href="/hexo-test/css/main.css">


<link rel="stylesheet" href="/hexo-test/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"d2372017513.github.io","root":"/hexo-test/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前言首先感谢大佬的无私奉献，愿意将自己的经验和技术分享给我们。贴上大佬的教程指北 教程页 项目代码见我的github Modeus 经过了长达半个月的跟班学习，跟着老师做还用了这么长的时间，原因无非是自己对于知识的掌握不牢靠，知识面的狭窄。同时，在不断的学习和修改自己编写中出现的bug之后，对于项目的开发和对于代码的理解都提高了一个档次！至此，秒杀系统的开发告一段落，那么是时候对其进行分析和总结了">
<meta property="og:type" content="article">
<meta property="og:title" content="秒杀系统开发文档及总结">
<meta property="og:url" content="http://d2372017513.github.io/hexo-test/Projects/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%E5%8F%8A%E6%80%BB%E7%BB%93/">
<meta property="og:site_name" content="半云半雾">
<meta property="og:description" content="前言首先感谢大佬的无私奉献，愿意将自己的经验和技术分享给我们。贴上大佬的教程指北 教程页 项目代码见我的github Modeus 经过了长达半个月的跟班学习，跟着老师做还用了这么长的时间，原因无非是自己对于知识的掌握不牢靠，知识面的狭窄。同时，在不断的学习和修改自己编写中出现的bug之后，对于项目的开发和对于代码的理解都提高了一个档次！至此，秒杀系统的开发告一段落，那么是时候对其进行分析和总结了">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/01/23/N31sEJcXigZtrY2.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/tHGLupCcBz1wSfD.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/ciJdtu67rhxq1OS.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/Y4K9OWMvedyf7qs.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/XM3aFnUcZhSPYTx.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/HLqREZaDslSkJKN.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/hNb26QCnELSYaco.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/VMqI8lEtf3YdH9u.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/dQvaTHyFgiYrZU4.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/9qZCBtmo1LjHvN6.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/fQqVFlYBsJStzpE.png">
<meta property="og:image" content="https://i.loli.net/2021/01/31/sTBXdcALQCUnieO.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/TkArOVjP8t6y5MF.png">
<meta property="og:image" content="https://i.loli.net/2021/01/31/51AUkcji9Z7f3FP.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/kDQdXo4WjOiJmw9.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/BqALo46QFUCXks8.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/SYdtXeMmfixjzPR.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/OPS1ZT5ARw9cJCq.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/xSyahQRfI9LJlbB.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/9SRQxwYCPA4Md6a.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/znA8SRjea7YkLxp.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/DcThpMGnxsJ1mWO.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/619MDfpPYslmVNG.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/rLAquaQkyNHv7Cg.png">
<meta property="og:image" content="https://i.loli.net/2021/02/22/dRWmzSPNOih8MKq.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/C8HJROjsyYK43Qe.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/2DYqw7NU8lGIEZO.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/YXWBnsmxtb4qTKu.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/B8P5lrb6JAy3qtS.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/NCsdPFEOSb4ZBMR.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/DFUOBRMuCGPwXWL.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/gEzyX7KAImhwGN1.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/poi2fQnE7JlRxs3.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/4YVgj2zt86sCHKn.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/TUgYoaR4Q8sDM69.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/M4vdJHsSgyOYjRx.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/IiGwvyCDuWZeM6O.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/F831j9dsWfRcANq.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/Wao1dD9uH7Cl8UJ.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/Bfm4UnSiax9ukho.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/PKLl3o6kzC4dNgm.png">
<meta property="og:image" content="https://i.loli.net/2021/02/23/8fWPK4NRIEAamTw.png">
<meta property="og:image" content="https://i.loli.net/2021/02/24/fljPVGkFqoZRMb6.png">
<meta property="og:image" content="https://i.loli.net/2021/02/24/Wt7GKZybLwUgYuJ.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/15010945-c2467aada6631ca2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/388/format/webp">
<meta property="og:image" content="https://i.loli.net/2021/02/24/fwPvQ86rHENskiF.png">
<meta property="og:image" content="https://i.loli.net/2021/02/25/gmqpNycr8zUbl5k.png">
<meta property="og:image" content="https://i.loli.net/2021/02/24/NA67qGwFTQWmfXK.png">
<meta property="og:image" content="https://i.loli.net/2021/02/24/Yl5Cd3NXM1xDSf6.png">
<meta property="og:image" content="https://i.loli.net/2021/02/24/f9Z8czOxQEdb2rF.png">
<meta property="og:image" content="https://i.loli.net/2021/02/25/Zm3UR8pIsc47ngk.png">
<meta property="article:published_time" content="2021-01-31T07:20:54.000Z">
<meta property="article:modified_time" content="2021-02-25T05:41:05.543Z">
<meta property="article:author" content="绯狱丸丶">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Projects">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/01/23/N31sEJcXigZtrY2.png">

<link rel="canonical" href="http://d2372017513.github.io/hexo-test/Projects/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%E5%8F%8A%E6%80%BB%E7%BB%93/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>秒杀系统开发文档及总结 | 半云半雾</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/hexo-test/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">半云半雾</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">测试ing</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/hexo-test/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/hexo-test/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">12</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/hexo-test/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">11</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/hexo-test/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">18</span></a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/hexo-test/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/d2372017513" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://d2372017513.github.io/hexo-test/Projects/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%E5%8F%8A%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo-test/images/ouba.jpg">
      <meta itemprop="name" content="绯狱丸丶">
      <meta itemprop="description" content="DHR‘s Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="半云半雾">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          秒杀系统开发文档及总结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-31 15:20:54" itemprop="dateCreated datePublished" datetime="2021-01-31T15:20:54+08:00">2021-01-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-25 13:41:05" itemprop="dateModified" datetime="2021-02-25T13:41:05+08:00">2021-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo-test/categories/Information-Security-Study/" itemprop="url" rel="index"><span itemprop="name">Information Security Study</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo-test/categories/Information-Security-Study/Code-Language/" itemprop="url" rel="index"><span itemprop="name">Code Language</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo-test/categories/Information-Security-Study/Code-Language/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo-test/categories/Projects/" itemprop="url" rel="index"><span itemprop="name">Projects</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>68k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:02</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首先感谢大佬的无私奉献，愿意将自己的经验和技术分享给我们。贴上大佬的教程指北 <a href="https://www.imooc.com/u/2145618/courses?sort=publish" target="_blank" rel="noopener">教程页</a></p>
<p>项目代码见我的github <a href="https://github.com/D2372017513/Seckill/tree/master" target="_blank" rel="noopener">Modeus</a></p>
<p>经过了长达半个月的跟班学习，跟着老师做还用了这么长的时间，原因无非是自己对于知识的掌握不牢靠，知识面的狭窄。同时，在不断的学习和修改自己编写中出现的bug之后，对于项目的开发和对于代码的理解都提高了一个档次！至此，秒杀系统的开发告一段落，那么是时候对其进行分析和总结了！</p>
<h1 id="一、工欲善其事，必先利其器"><a href="#一、工欲善其事，必先利其器" class="headerlink" title="一、工欲善其事，必先利其器"></a>一、工欲善其事，必先利其器</h1><p>该项目使用到的工具包括但不限于 IDEA 编辑器，Maven 项目管理器，Spring + MVC + BootStrap 框架，语言主要使用 Java 语言和 JS,日志使用的是 slf4j 的最新版 logback，数据库连接池用的 c3p0，单元测试用的 JUnit 4。</p>
<h2 id="1-1-IDEA-的配置"><a href="#1-1-IDEA-的配置" class="headerlink" title="1.1 IDEA 的配置"></a>1.1 IDEA 的配置</h2><p>IDEA 是对 Java 开发非常友好的编辑器，利用它做开发能达到事半功倍的效果。</p>
<p>IDEA 本体的安装及配置网上教程很多，这里不做赘述。那么我们需要在IDEA 中自行安装及配置的就只有 Maven 了（其实也不用， IDEA 已经将 Maven 做了整合，但是我用的时候出现了一些问题，故采用自己安装配置的 Maven ，同时自己安装配置也能保证使用的是最新的版本）。Go on &gt;&gt;&gt;</p>
<h2 id="1-2-Maven-的安装及配置"><a href="#1-2-Maven-的安装及配置" class="headerlink" title="1.2 Maven 的安装及配置"></a>1.2 Maven 的安装及配置</h2><p>官网下载最新的压缩包解压即可，配置环境变量，新建一个变量</p>
<p><img data-src="https://i.loli.net/2021/01/23/N31sEJcXigZtrY2.png" alt="image-20210117124518118"></p>
<p>再在 path 目录下添加     <code>%MAVEN_HOME%\bin</code></p>
<p><img data-src="https://i.loli.net/2021/01/23/tHGLupCcBz1wSfD.png" alt="image-20210117124601374"></p>
<p>打开 powershell 输入 <code>mvn -version</code> 出现</p>
<p><img data-src="https://i.loli.net/2021/01/23/ciJdtu67rhxq1OS.png" alt="image-20210117124748760"></p>
<p>打开解压后的目录文件下的 conf 文件夹，修改其中的 settings.xml 配置文件</p>
<a id="more"></a>

<p>更改默认的本地仓库地址（目录自己新建）</p>
<p><img data-src="https://i.loli.net/2021/01/23/Y4K9OWMvedyf7qs.png" alt="image-20210117125028943"></p>
<p>更换镜像网站（提升下载速度）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 注意添加到 mirrors 标签域内 --&gt;</span>	 </span><br><span class="line"><span class="comment">&lt;!--设置阿里云镜像--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>声明 JDK 版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 注意添加到 profiles 标签域内 --&gt;</span>	 	</span><br><span class="line"><span class="comment">&lt;!--java版本--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>保存配置，在 powershell 中输入 maven 仓库更新指令 <code>mvn help:system</code>，出现</p>
<p><img data-src="https://i.loli.net/2021/01/23/XM3aFnUcZhSPYTx.png" alt="image-20210117125433386"></p>
<p>打开自建的仓库目录可见</p>
<p><img data-src="https://i.loli.net/2021/01/23/HLqREZaDslSkJKN.png" alt="image-20210117125507620"></p>
<p><strong><em>注意：</em></strong></p>
<p><em>这里下载的并不是所有将来可能会用到的 JAR ，以后若使用到未下载的 JAR 包，IDEA 会提示更新仓库（下面有讲到）</em></p>
<p>有了 Maven 这个项目管理神器，我们可以将精力放在对于程序的开发上面来，不需要为各种框架的依赖而烦恼。下面讲如何使用 IDEA 和 Maven 进行我们的开发工作。</p>
<h2 id="1-3-使用-IDEA-创建自己的项目并利用-Maven-引入需要的依赖"><a href="#1-3-使用-IDEA-创建自己的项目并利用-Maven-引入需要的依赖" class="headerlink" title="1.3 使用 IDEA 创建自己的项目并利用 Maven 引入需要的依赖"></a>1.3 使用 IDEA 创建自己的项目并利用 Maven 引入需要的依赖</h2><p>新建一个项目，取名为 seckill ，并在其中添加 maven 框架依赖，选择使用原型创建</p>
<p><img data-src="https://i.loli.net/2021/01/23/hNb26QCnELSYaco.png" alt="image-20210117135153846"></p>
<p>使用自行解压的版本，不使用与 IDEA 绑定的版本</p>
<p><img data-src="https://i.loli.net/2021/01/23/VMqI8lEtf3YdH9u.png" alt="image-20210117135337657"></p>
<p>IDEA 中环境自动配置的 Servlet2.3 jsp 的 el 表达式是不工作的，手动更换版本，把 WEB-INF 下的 web.xml 更改为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee            http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>手动向 maven 的配置文件中添加相应的依赖，IDEA 添加时可能因为没有相应的 JAR 包而报错标红，但是并不影响，在全部添加完毕后点击 maven 的同步按钮就会自动的将需要的 JAR 包添加到本地目录里面。（后面需要用到的依赖也一并在此添加了）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 补全项目依赖 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--   1、日志 java 日志：slf4j，log4j，logback，common-logging</span></span><br><span class="line"><span class="comment">                slf4j 是规范/接口</span></span><br><span class="line"><span class="comment">                日志实现：log4j，logback，common-logging</span></span><br><span class="line"><span class="comment">                使用：slf4j + logback</span></span><br><span class="line"><span class="comment">                --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  添加 slf4j 依赖，不然 logback 不能用      --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  添加 logback-core 核心依赖      --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  添加 logback-classic 依赖，实现并整合 slf4j 接口      --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  2、添加数据库相关依赖     --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  优化链接反馈      --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.mchange/c3p0 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;groupId&gt;c3p0&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;artifactId&gt;c3p0&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;version&gt;0.9.1.2&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;/dependency&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--  3、DAO层：MyBatis 依赖      --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--   MyBatis 自身实现的 Spring 依赖     --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--  Servlet Web 相关依赖      --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  引入相关 jsp 标签      --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>taglibs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>standard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--  4、Spring 依赖      --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  1）核心依赖      --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  2) spring DAO 层依赖     --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--  3）spring web 相关依赖      --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--  4）spring test 相关依赖      --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--   redis 客户端：Jedis 依赖     --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--   序列化操作依赖     --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="1-4-Mybatis-的配置"><a href="#1-4-Mybatis-的配置" class="headerlink" title="1.4 Mybatis 的配置"></a>1.4 Mybatis 的配置</h2><p><a href="https://mybatis.org/mybatis-3/zh/getting-started.html" target="_blank" rel="noopener">Mybatis官方中文文档地址</a></p>
<p>从 Maven 配置文件中可以看到，我们引入了对 Mybatis 框架的支持</p>
<p><img data-src="https://i.loli.net/2021/02/01/dQvaTHyFgiYrZU4.png" alt="image-20210201115045514"></p>
<p>那么接下来就是对 Mybatis 的配置</p>
<p>在 main 文件夹下新建 resources 文件夹用于存放我们的各种配置文件，并新建 mybatis-config.xml </p>
<p><img data-src="https://i.loli.net/2021/02/01/9qZCBtmo1LjHvN6.png" alt="image-20210201115417746"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 标准的 xml 文档开头 --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Mybatis 配置文件开头，不用记，去官网的开发文档上随便找个示例 copy 过来就行 --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置全局属性 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置使用 JDBC 的 getGenerationKeys 获取数据库的自增主键值 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useGeneratedKeys"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用列别名替换列名 ，默认为 true --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useColumnLabel"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 开启驼峰命名转换，这个属性会帮我们将 seckillId &lt; - &gt; seckill_id 互相转换 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>顺便把 logback 也配置了</p>
<p><code>logback.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"debug"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>至此，项目初期的开发条件便算是备齐了，那么下一步进行我们业务逻辑的分析，为之后的开发理清楚头绪。</p>
<h1 id="二、秒杀系统业务逻辑梳理"><a href="#二、秒杀系统业务逻辑梳理" class="headerlink" title="二、秒杀系统业务逻辑梳理"></a>二、秒杀系统业务逻辑梳理</h1><h2 id="2-1-整体业务逻辑梳理"><a href="#2-1-整体业务逻辑梳理" class="headerlink" title="2.1 整体业务逻辑梳理"></a>2.1 整体业务逻辑梳理</h2><p><img data-src="https://i.loli.net/2021/01/23/fQqVFlYBsJStzpE.png" alt="image-20210117140035169"></p>
<p>从上图中可以看到，我们的秒杀系统存在着三个角色：商家、仓库和用户。</p>
<ul>
<li><strong>商家：</strong>负责向仓库中添加和调整商品的数量和价格；</li>
<li><strong>仓库：</strong>进行货物的暂时存储以及将货物展现给用户浏览的作用；</li>
<li><strong>用户：</strong>则扮演着购买者的角色，对商品发起秒杀声明占有权；</li>
</ul>
<p>将其抽象到开发过程中，对应关系则可以表示为：</p>
<ul>
<li>商家 -&gt; 数据库管理人员</li>
<li>仓库 -&gt; 数据库</li>
<li>用户 -&gt; 买家</li>
</ul>
<p>可以看出，仓库（数据库）在中间扮演者桥梁的作用，将买卖双方链接在了一起，同时也是整个业务的核心部件，一起的操作都是围绕着对数据库的操作进行的。同样的以后的优化也是对数据库的操作进行着优化。</p>
<h2 id="2-2-用户层逻辑梳理"><a href="#2-2-用户层逻辑梳理" class="headerlink" title="2.2 用户层逻辑梳理"></a>2.2 用户层逻辑梳理</h2><p><img data-src="https://i.loli.net/2021/01/31/sTBXdcALQCUnieO.png" alt="image-20210117140208711"></p>
<p>用户在整个业务中产生的事务操作，可以笼统的概括为以上的行为。即：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*用户发起秒杀 -&gt; 平台对用户信息进行核实 -&gt; 核验成功进入购买逻辑*（不成功则拒绝访问） -&gt; 记录购买行为，以及减库存操作 -&gt; 事务管*理机制核验事务是否执行成功 -&gt; 成功则进行数据落地（秒杀成功），反之则进行事务回滚（秒杀失败）</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>在上面的秒杀过程中便产生了购买行为，那么在本业务中什么是购买行为呢？如下：</p>
<p><img data-src="https://i.loli.net/2021/01/23/TkArOVjP8t6y5MF.png" alt="image-20210117140248451"></p>
<p>购买行为中记录了购买者的各项标志性信息，以供我们去控制购买行为正常合理的发生。对于用户产生的购买行为的管控也是本业务开发的难点。</p>
<p><img data-src="https://i.loli.net/2021/01/31/51AUkcji9Z7f3FP.png" alt="image-20210117153222776"></p>
<p>上图描述的是多个用户对同一款商品进行秒杀产生的高并发问题，是后面开发的需要优化的问题。</p>
<h2 id="2-3-业务功能的梳理"><a href="#2-3-业务功能的梳理" class="headerlink" title="2.3 业务功能的梳理"></a>2.3 业务功能的梳理</h2><p>这里做一个简单的系统的功能分析。同样的，对于功能的梳理也是站在业务逻辑的角色层面上决定要开发什么功能。</p>
<p><img data-src="https://i.loli.net/2021/01/23/kDQdXo4WjOiJmw9.png" alt="image-20210117153825789"></p>
<p><strong>数据库：</strong>DAO 的接口设计、数据库表的设计、如何通过 MyBatis 实现 DAO </p>
<p><strong>后端：</strong>Service 的接口设计，通过 Spring 去管理 Service 的接口、通过 Spring 的声明式事务控制简化 Service 层的事务控制</p>
<p><strong>前端：</strong>Web 设计、前端交互界面的设计</p>
<p>经过这几节的内容，相信我们对于这个业务已经有了初步的认识，下面进入到我们的开发流程。</p>
<h1 id="三、DAO-层的开发"><a href="#三、DAO-层的开发" class="headerlink" title="三、DAO 层的开发"></a>三、DAO 层的开发</h1><p>整个秒杀系统都是围绕着对数据库的操作进行开发，那么至关重要的便是对于数据层的接口设计，也就是我们的 DAO 层接口设计。在我们设计接口的时候应该站在使用者（也就是用户）的角度来思考接口应该怎么样去设计，应该包含哪些功能。在这个秒杀系统中必不可少的是用户进行秒杀后引发的一系列事务，那么如何将具体的操作抽象为我们的方法，就是我们需要考虑的事情了。</p>
<h2 id="3-1-数据库设计"><a href="#3-1-数据库设计" class="headerlink" title="3.1 数据库设计"></a>3.1 数据库设计</h2><p>根据我们上面提到的，数据库的作用是为了存储<strong>商品信息</strong>和<strong>购买成功的买家明细</strong>，那么数据库的设计也应该围绕着这两个方面设计：</p>
<ol>
<li>对于商品：<ul>
<li>商品的唯一性标识，也就是商品的 ID</li>
<li>商品的名称 name</li>
<li>商品的价格price（本系统未涉及）</li>
<li>商品的秒杀开始（ start_time ）和结束时间（end_time）</li>
<li>商品的创建时间（create_time）</li>
<li>商品的数量 （number）</li>
</ul>
</li>
<li>对于买家：<ul>
<li>买家的唯一性标识，手机号码 Phone</li>
<li>买家所购买的商品 ID</li>
<li>买家购买的时间 create_time</li>
</ul>
</li>
</ol>
<p>那么有了对各个表单的属性梳理，接下来就是去创建我们的数据库了。</p>
<h3 id="3-1-1-项目的创建"><a href="#3-1-1-项目的创建" class="headerlink" title="3.1.1 项目的创建"></a>3.1.1 项目的创建</h3><p>在 main 文件夹下新建 sql 文件夹，里面用来存放项目要用到的 sql 文件，如图：<br><img data-src="https://i.loli.net/2021/02/01/BqALo46QFUCXks8.png" alt="image-20210201110429110">习</p>
<p>在文件夹下新建我们的 sql 文件 schema.sql (这里我使用的是 MySQL 8.0 版本数据库，读者可自行选择)</p>
<h3 id="3-1-2-数据库的创建"><a href="#3-1-2-数据库的创建" class="headerlink" title="3.1.2 数据库的创建"></a>3.1.2 数据库的创建</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> seckill;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用数据库</span></span><br><span class="line"><span class="keyword">USE</span> seckill;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建秒杀商品表单，</span></span><br><span class="line"><span class="comment">-- 这里需要注意的是，对数据库字段的引用需要使用反引号``（也就是键盘 esc 下面的那个，不然会报语法错误），COMMENT 注释用 '' 平常的单引号</span></span><br><span class="line"><span class="comment">-- 在创建完毕表单过后可以使用 show create table table_name 来查看具体创建表单的 sql 语句是什么</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> seckill;</span><br><span class="line">(</span><br><span class="line">    `seckill_id` BIGINT NOT NULL AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'商品id'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品名'</span>,</span><br><span class="line">    <span class="string">`number`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品数量'</span>,</span><br><span class="line">    <span class="string">`start_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'开始时间'</span>,</span><br><span class="line">    <span class="string">`end_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'结束时间'</span>,</span><br><span class="line">    <span class="string">`create_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>, <span class="comment">-- 当 TIMESTAMP 类型设置了 DEFAULT CURRENT_TIMESTAMP 属性过后，如果不指定值，则会用当前时间进行填充</span></span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (seckill_id),</span><br><span class="line">    <span class="keyword">KEY</span> idx_start_time (start_time),</span><br><span class="line">    <span class="keyword">KEY</span> idx_end_time (end_time),</span><br><span class="line">    <span class="keyword">KEY</span> idx_create_time (create_time)</span><br><span class="line">)<span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">AUTO_INCREMENT = <span class="number">1000</span> <span class="comment">-- 让表中的自增字段从 1000 开始自增</span></span><br><span class="line"><span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8 <span class="keyword">COMMENT</span> = <span class="string">'秒杀库存表'</span> <span class="comment">-- 注意：字符编码格式是 utf8 不是 utf-8 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 初始化数据</span></span><br><span class="line"><span class="comment">-- create_time 是自动填充，所以我们这里就不管了</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> seckill (<span class="keyword">name</span>,<span class="built_in">number</span>,start_time,end_time)</span><br><span class="line">	<span class="keyword">values</span> (<span class="string">'1000元秒杀IPhone 12'</span>, <span class="number">100</span>, <span class="string">'2021-01-18 00:00:00'</span>, <span class="string">'2021-01-19 00:00:00'</span>),</span><br><span class="line">       (<span class="string">'10元秒杀垃圾袋'</span>, <span class="number">1000</span>, <span class="string">'2021-01-16 00:40:00'</span>, <span class="string">'2021-01-19 00:00:00'</span>),</span><br><span class="line">       (<span class="string">'36元秒杀大米'</span>, <span class="number">10000</span>, <span class="string">'2021-01-17 08:00:00'</span>, <span class="string">'2021-01-20 00:00:00'</span>),</span><br><span class="line">       (<span class="string">'500元秒杀大会员'</span>, <span class="number">999</span>, <span class="string">'2021-01-18 10:00:00'</span>, <span class="string">'2021-01-25 00:00:00'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建秒杀成功明细表，记录用户的相关信息</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> success_killed</span><br><span class="line">(</span><br><span class="line">    <span class="string">`seckill_id`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品 ID '</span>, <span class="comment">-- 这里不设置自增是因为后面的 ID 值都是记录传过来的值，所以不需要自增</span></span><br><span class="line">    <span class="string">`user_phone`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> NOLL <span class="keyword">COMMENT</span> <span class="string">'用户手机号'</span>,</span><br><span class="line">    <span class="string">`state`</span> <span class="built_in">TINYINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'秒杀单状态'</span>, <span class="comment">-- 这里设计了一个状态标识码，用来识别秒杀单的状态，具体状态值后面通过枚举类来设计，先写个0占位</span></span><br><span class="line">    <span class="string">`create_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>, <span class="comment">-- 跟上面一样，自动填充</span></span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (seckill_id,user_phone), <span class="comment">-- 联合主键，保证秒杀信息的唯一性</span></span><br><span class="line">    <span class="keyword">KEY</span> idx_create_time (create_time)</span><br><span class="line">)<span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line"><span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8 <span class="keyword">COMMENT</span> = <span class="string">'秒杀成功明细表'</span>;</span><br></pre></td></tr></table></figure>

<p>右键执行，有错改错，无错则可以 show 一下创建的 sql 语句，可以看到</p>
<p><img data-src="https://i.loli.net/2021/02/01/SYdtXeMmfixjzPR.png" alt="image-20210201114541539"></p>
<p>同理，success_killed 表单也可以看一下</p>
<p>然后查看一下表单里的数据</p>
<p><img data-src="https://i.loli.net/2021/02/01/OPS1ZT5ARw9cJCq.png" alt="image-20210201114651054"></p>
<p>success_killed 表单中因为我们并没有进行添加所以应该是空的。</p>
<p>下面进行两个表单对应的数据实体开发。</p>
<h2 id="3-2-数据库对应实体的开发"><a href="#3-2-数据库对应实体的开发" class="headerlink" title="3.2 数据库对应实体的开发"></a>3.2 数据库对应实体的开发</h2><p>数据实体的开发对应的是相应的数据库，数据库中的字段也就对应着实体中的变量。</p>
<p>在main文件夹下创建目录 java.org.seckill.entity 用来存放我们的数据实体。然后新建两个数据库对应的实体类 SecKill 和 SuccessKilled ,声明变量并创建相应的 getter 和setter 方法。为了后面的显示方便，重写 toString 方法</p>
<p><img data-src="https://i.loli.net/2021/02/01/xSyahQRfI9LJlbB.png" alt="image-20210201153429721"></p>
<p><code>SecKill</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecKill</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> secKillId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date startTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSecKillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> secKillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecKillId</span><span class="params">(<span class="keyword">long</span> secKillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.secKillId = secKillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumber</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getStartTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStartTime</span><span class="params">(Date startTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startTime = startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getEndTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEndTime</span><span class="params">(Date endTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.endTime = endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTime</span><span class="params">(Date createTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SecKill&#123;"</span> +</span><br><span class="line">                <span class="string">"secKillId="</span> + secKillId +</span><br><span class="line">                <span class="string">", name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", number="</span> + number +</span><br><span class="line">                <span class="string">", startTime="</span> + startTime +</span><br><span class="line">                <span class="string">", endTime="</span> + endTime +</span><br><span class="line">                <span class="string">", createTime="</span> + createTime +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SuccessKilled</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuccessKilled</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> secKillId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userPhone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">short</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SecKill secKill;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecKill <span class="title">getSecKill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> secKill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecKill</span><span class="params">(SecKill secKill)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.secKill = secKill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSecKillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> secKillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecKillId</span><span class="params">(<span class="keyword">long</span> secKillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.secKillId = secKillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getUserPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userPhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserPhone</span><span class="params">(<span class="keyword">long</span> userPhone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userPhone = userPhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">short</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTime</span><span class="params">(Date createTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SuccessKilled&#123;"</span> +</span><br><span class="line">                <span class="string">"secKillId="</span> + secKillId +</span><br><span class="line">                <span class="string">", userPhone="</span> + userPhone +</span><br><span class="line">                <span class="string">", state="</span> + state +</span><br><span class="line">                <span class="string">", createTime="</span> + createTime +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-数据库访问对象-DAO-层的开发"><a href="#3-3-数据库访问对象-DAO-层的开发" class="headerlink" title="3.3 数据库访问对象 DAO 层的开发"></a>3.3 数据库访问对象 DAO 层的开发</h2><p>对数据库访问对象的开发应该围绕着对相应的实体进行操作，那么我们的开发目的就很明确了，无非提供对实体的增删改查操作。有了这个思路，下面就来进行我们的开发。</p>
<h3 id="3-3-1-DAO-层接口的开发"><a href="#3-3-1-DAO-层接口的开发" class="headerlink" title="3.3.1 DAO 层接口的开发"></a>3.3.1 DAO 层接口的开发</h3><p>首先创建目录 <code>main.org.seckill.dao</code> 用来存放我们的接口</p>
<p><img data-src="https://i.loli.net/2021/02/01/9SRQxwYCPA4Md6a.png" alt="image-20210201154955087"></p>
<p><code>SecKillDao</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SecKill;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里的方法名中的参数名前面都加了个 @Param 的注解，意思是这个参数被引用的时候的参数名，建议都加上</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一般来说接口是为了为相应的实体进行操作的</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SecKillDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减少库存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secKillId 秒杀商品ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> killTime  秒杀时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">reduceNumber</span><span class="params">(@Param(<span class="string">"secKillId"</span>)</span> <span class="keyword">long</span> secKillId,@<span class="title">Param</span><span class="params">(<span class="string">"killTime"</span>)</span> Date killTime)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 ID 查询秒杀对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secKillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SecKill <span class="title">queryById</span><span class="params">(@Param(<span class="string">"secKillId"</span>)</span> <span class="keyword">long</span> secKillId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据偏移量查询秒杀列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> offset</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> limit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;SecKill&gt; <span class="title">queryAll</span><span class="params">(@Param(<span class="string">"offset"</span>)</span> <span class="keyword">int</span> offset,@<span class="title">Param</span><span class="params">(<span class="string">"limit"</span>)</span> <span class="keyword">int</span> limit)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SuccessKilledDao</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SuccessKilled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SuccessKilledDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入购买明细，可过滤重复</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secKillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertSuccessKilled</span><span class="params">(@Param(<span class="string">"secKillId"</span>)</span> <span class="keyword">long</span> secKillId , @<span class="title">Param</span><span class="params">(<span class="string">"userPhone"</span>)</span> <span class="keyword">long</span> userPhone )</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 id 查询 SuccessKilled 并携带秒杀产品对象实体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secKillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SuccessKilled <span class="title">queryByIdWithSecKill</span><span class="params">(@Param(<span class="string">"secKillId"</span>)</span> <span class="keyword">long</span> secKillId,@<span class="title">Param</span><span class="params">(<span class="string">"userPhone"</span>)</span> <span class="keyword">long</span> userPhone)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口的实现我们交由 Mybatis 来帮我们实现，那么接下来就利用 Mybatis 来帮我们实现我们的接口。</p>
<h3 id="3-3-2-Mybatis-实现-DAO-接口"><a href="#3-3-2-Mybatis-实现-DAO-接口" class="headerlink" title="3.3.2 Mybatis 实现 DAO 接口"></a>3.3.2 Mybatis 实现 DAO 接口</h3><p>我们这里只用简单的实现一下接口就行了，如果想要要了解更多更深入的应用，建议去翻阅 Mybatis 的官方文档。</p>
<p>在 resources 文件夹下创建 mapper 文件夹存放 Mybatis 的 xml 配置文件</p>
<p><img data-src="https://i.loli.net/2021/02/01/znA8SRjea7YkLxp.png" alt="image-20210201163003874"> </p>
<p><code>SecKillDao.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mapper 的 </span></span><br><span class="line"><span class="comment"> namespace 属性值是我们将要实现接口的地址</span></span><br><span class="line"><span class="comment"> id 属性值是我们实现的接口中的方法名</span></span><br><span class="line"><span class="comment"> resultType 属性值是着实现的方法的返回值类型</span></span><br><span class="line"><span class="comment"> parameterType 属性值是参数类型，可以省略</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"org.seckill.dao.SecKillDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"reduceNumber"</span>&gt;</span></span><br><span class="line"># 需要注意的是，mapper 中包含的 sql 语句只能是单条语句，也就是不能有分号，不然会报错，血的教训，这也是我为什么要注释而不是删掉的原因</span><br><span class="line">#         use seckill;</span><br><span class="line">        update</span><br><span class="line">            seckill.seckill s</span><br><span class="line">        set number = number - 1</span><br><span class="line">        where seckill_id = #&#123;secKillId&#125;</span><br><span class="line">          and start_time &lt;![CDATA[ &lt;= ]]&gt; #&#123;killTime&#125;</span><br><span class="line">          and end_time &gt;= #&#123;killTime&#125;</span><br><span class="line">          and number &gt; 0</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryById"</span> <span class="attr">resultType</span>=<span class="string">"SecKill"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">#         use seckill;</span><br><span class="line">        select seckill_id,name,number,start_time,end_time,create_time</span><br><span class="line">        from seckill.seckill</span><br><span class="line">        where seckill_id = #&#123;secKillId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryAll"</span> <span class="attr">resultType</span>=<span class="string">"SecKill"</span>&gt;</span></span><br><span class="line">#         use seckill;</span><br><span class="line">        select `seckill_id`, `name`, `number`, `start_time`, `end_time`, `create_time`</span><br><span class="line">        from seckill.seckill</span><br><span class="line">        order by `create_time` desc</span><br><span class="line">        limit #&#123;offset,jdbcType=INTEGER&#125;,#&#123;limit,jdbcType=INTEGER&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>SuccessKilled.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"org.seckill.dao.SuccessKilledDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertSuccessKilled"</span>&gt;</span></span><br><span class="line">        # 这里的 ignore 限定了插入记录不能重复</span><br><span class="line">        insert ignore into seckill.success_killed(seckill_id, user_phone)</span><br><span class="line">        values (#&#123;secKillId&#125;, #&#123;userPhone&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryByIdWithSecKill"</span> <span class="attr">resultType</span>=<span class="string">"SuccessKilled"</span>&gt;</span></span><br><span class="line">        select sk.seckill_id,</span><br><span class="line">               sk.user_phone,</span><br><span class="line">               sk.state,</span><br><span class="line">               sk.create_time,</span><br><span class="line">               s.seckill_id "seckill.seckill_id",</span><br><span class="line">               s.name "seckill.name",</span><br><span class="line">               s.number "seckill.number",</span><br><span class="line">               s.start_time "seckill.start_time",</span><br><span class="line">               s.end_time "seckill.end_time",</span><br><span class="line">               s.create_time "seckill.create_time"</span><br><span class="line">        from seckill.success_killed sk</span><br><span class="line">            <span class="comment">&lt;!-- 联合查询 将 seckill 别名命名为 s ，将 successed_kill 别名命名为 sk --&gt;</span></span><br><span class="line">                 inner join seckill.seckill s on sk.seckill_id = s.seckill_id</span><br><span class="line">        where sk.seckill_id = #&#123;secKillId&#125; and sk.user_phone = #&#123;userPhone&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接口的实现到此告一段落，但是我们会发现这跟我们用 JDBC 的实现接口的时候并不一样，最大的不一样就是没有数据库连接的操作！那么是我们省略掉了？Mybatis 连这个都帮我们做了？猜对了一半， Mybatis 当然不可能聪明到能够读取我们的心理，从而直接猜到我们需要链接的数据库是哪个，甚至连用户名密码都知道了，如果真是这样，那人工智能觉醒就在现在~</p>
<p>回到项目上来，如果 Mybatis 没有帮我们做数据库的连接，那意味着我们还是要自己手动配置，也就是我们下面要说到的：Spring 整合 Mybatis。</p>
<h2 id="3-4-Spring-整合-Mybatis"><a href="#3-4-Spring-整合-Mybatis" class="headerlink" title="3.4 Spring 整合 Mybatis"></a>3.4 Spring 整合 Mybatis</h2><p>有 Spring 基础的伙伴们应该都知道 Spring 是拿来干什么的。当我们在 Spring 中配置好了我们的 bean 对象过后，可以通过注解或者 xml 的方式将创建好的 bean 对象注入到我们需要的地方。</p>
<p>我们通过上面的 Mybatis 对 DAO 接口进行了实现，省去了我们创建实现类的操作，那么问题来了，Mybatis 实现的类要怎么去使用呢？这就需要用到 Spring 了，我们通过配置创建实现类的 bean 对象，那么在需要用到实现类的时候，通过注解的方式就可以将实现类注入到我们需要的地方。</p>
<h3 id="3-4-1-Spring-的配置"><a href="#3-4-1-Spring-的配置" class="headerlink" title="3.4.1 Spring 的配置"></a>3.4.1 Spring 的配置</h3><p>在 resources 文件夹下创建一个数据库参数的 jdbc.properties 文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># properties 里面的所有数据都是以键值对的方式进行存储的，value 值都不用双引号，并且后面不能跟空格，输完直接回车</span></span><br><span class="line"><span class="comment"># 数据库驱动</span></span><br><span class="line"><span class="attr">driver</span> = <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment"># 数据库连接</span></span><br><span class="line"><span class="comment"># jdbc:mysql://127.0.0.1:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC 解决时区和中文乱码问题</span></span><br><span class="line"><span class="attr">jdbcUrl</span> = <span class="string">jdbc:mysql://localhost:3306/seckill?serverTimezone=UTC</span></span><br><span class="line"><span class="comment"># 自行输入自己的，输入注意事项见第一行</span></span><br><span class="line"><span class="comment"># USER_NAME</span></span><br><span class="line"><span class="attr">user_name</span> = <span class="string">xxxxx</span></span><br><span class="line"><span class="comment"># PWD</span></span><br><span class="line"><span class="attr">pwd</span> = <span class="string">xxxxxxx</span></span><br></pre></td></tr></table></figure>

<p>新建一个文件夹 spring 用来存放 Spring 的配置文件 </p>
<p><code>spring-dao.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 定义参数扫描地址，用来注入类似于 JDBC 连接池的参数的 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:jdbc.properties"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置连接池属性 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"$&#123;driver&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbcUrl&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">value</span>=<span class="string">"$&#123;user_name&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;pwd&#125;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- c3p0 连接池的私有属性 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxPoolSize"</span> <span class="attr">value</span>=<span class="string">"30"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minPoolSize"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 关闭连接后不自动提交，默认是 false ，但还是自己配置一遍，告诉自己有这么个玩意 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"autoCommitOnClose"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 设定连接超时时间，默认为 0，也就是无限等待 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"checkoutTimeout"</span> <span class="attr">value</span>=<span class="string">"1000"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 设定连接失败后重试次数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"acquireRetryAttempts"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置 SqlSessionFactory 对象 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入数据库连接池，会在生成 bean 对象时自动注入 dataSource 对象 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置 MyBatis 全局配置文件的位置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"classpath:mybatis-config.xml"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 扫描 entity 包下的类，并生成他们的别名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"typeAliasesPackage"</span> <span class="attr">value</span>=<span class="string">"org.seckill.entity"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 扫描 sql 配置文件：mapper 需要的 xml 文件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapperLocations"</span> <span class="attr">value</span>=<span class="string">"classpath:mapper/*.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置扫描 Dao 接口包，动态实现 Dao 接口，注入到 Spring 容器中 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入 sqlSessionFactory 对象 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sqlSessionFactoryBeanName"</span> <span class="attr">value</span>=<span class="string">"sqlSessionFactory"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 给出需要扫描的 Dao 接口包 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basePackage"</span> <span class="attr">value</span>=<span class="string">"org.seckill.dao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-5-单元测试"><a href="#3-5-单元测试" class="headerlink" title="3.5 单元测试"></a>3.5 单元测试</h2><p>在 DAO 接口界面右键生成单元测试类，选择全部方法</p>
<p><img data-src="https://i.loli.net/2021/02/01/DcThpMGnxsJ1mWO.png" alt="image-20210201164527651"></p>
<p><img data-src="https://i.loli.net/2021/02/01/619MDfpPYslmVNG.png" alt="image-20210201164546119"></p>
<p><img data-src="https://i.loli.net/2021/02/01/rLAquaQkyNHv7Cg.png" alt="image-20210201164657076"></p>
<p>另外一个接口也一样。生成后编写测试方法</p>
<p><code>SecKillDaoTest</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SecKill;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置 Spring 和 JUnit 整合，JUnit 启动时加载 SpringIOC 容器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">@ContextConfiguration("classpath:spring/spring-dao.xml")</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecKillDaoTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SecKillDao secKillDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> id = <span class="number">1000</span>;</span><br><span class="line">        SecKill secKill = secKillDao.queryById(id);</span><br><span class="line">        System.out.println(secKill.getName());</span><br><span class="line">        System.out.println(secKill);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(secKillDao.queryAll(<span class="number">0</span>,<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SuccessKilledDaoTest</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SuccessKilled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.*;</span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">@ContextConfiguration("classpath:spring/spring-dao.xml")</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuccessKilledDaoTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilledDao successKilledDao;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertSuccessKilled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        successKilledDao.insertSuccessKilled(<span class="number">1000</span>,<span class="number">13228217105L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryByIdWithSecKill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SuccessKilled successKilled = successKilledDao.queryByIdWithSecKill(<span class="number">1000</span>,<span class="number">13228217105L</span>);</span><br><span class="line">        System.out.println(successKilled);</span><br><span class="line">        System.out.println(successKilled.getSecKill());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SuccessKilled&#123;secKillId=1000,</span></span><br><span class="line"><span class="comment">     * userPhone=13228217105,</span></span><br><span class="line"><span class="comment">     * state=0,</span></span><br><span class="line"><span class="comment">     * createTime=Mon Jan 25 19:23:26 CST 2021&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * SecKill&#123;secKillId=1000,</span></span><br><span class="line"><span class="comment">     * name='1000元秒杀IPhone 12',</span></span><br><span class="line"><span class="comment">     * number=100,</span></span><br><span class="line"><span class="comment">     * startTime=Mon</span></span><br><span class="line"><span class="comment">     * Jan 18 08:00:00 CST 2021,</span></span><br><span class="line"><span class="comment">     * endTime=Tue Jan 19 08:00:00 CST 2021,</span></span><br><span class="line"><span class="comment">     * createTime=Mon Jan 18 00:50:38 CST 2021&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果测试出现错误可以参照我的错误信息以及修改方法进行修改 <a href="https://www.cnblogs.com/Constantin/p/14327326.html" target="_blank" rel="noopener">在 Spring 整合 Mybatis 中出现的问题及解决方案</a> ，但应该是不会出现我同样的错误，毕竟我都改了是吧^^</p>
<p>其实就我们现在这个层面，最难的反而不是逻辑代码的开发，而是环境的配置，因为不熟练。熟而生巧，道阻且长。</p>
<p>那么下面进入到我们 service 层的开发流程</p>
<h1 id="四、SERVICE-的开发"><a href="#四、SERVICE-的开发" class="headerlink" title="四、SERVICE 的开发"></a>四、SERVICE 的开发</h1><p>前面提到，DAO 层的编写主要是为了实现对数据库的操作。而提供对 DAO 逻辑操作的代码则应该放在 Service 层中来编写，这样可以让我们的项目结构更加的清晰分明。也方便以后的维护和更改。</p>
<h2 id="4-1-Service-接口的设计"><a href="#4-1-Service-接口的设计" class="headerlink" title="4.1 Service 接口的设计"></a>4.1 Service 接口的设计</h2><p>Service 层的编写跟 DAO 层的编写大同小异，首先都应该对其应该提供的功能进行分析，这样能帮助我们更好的去设计编写 Service 层的代码。</p>
<p>对于接口的设计，开发人员需要站在使用者的角度去设计接口。也就是用户将要使用到那些功能，从这个角度去设计接口，可以减少我们编写的接口冗余度。<strong>同时，对于接口的开发应该注意三方面：</strong></p>
<ol>
<li><strong>方法定义的粒度</strong>：我们设计的方法的功能应该越明确越好，不要想着用一个方法就可以把所有事情一起干了</li>
<li><strong>参数</strong>：一个方法的参数应该越简单越好，这样方便我们对数据进行更好的处理</li>
<li><strong>返回值</strong>：返回值也应该越简约越好，如果需要返回很多不同类型的数据，我们可以考虑将其封装成一个类；同样的，返回值也可以是一个异常，在开发中某些异常是允许存在的，他可以帮助我们更好的去跟踪程序动态</li>
</ol>
<p>那么基于以上的原则，我们这个简单的秒杀系统的功能分析就不算太难了：</p>
<ul>
<li>getSeckillList() &amp; getById()：考虑到 web 端的商品总单和单个商品详情页的需求，应该设计查询方法</li>
<li>exportSeckillUrl()：显示商品的详细秒杀信息（如果开启返回秒杀接口，反之则返回开始时间）</li>
<li>executeSeckill()：当秒杀开始后执行秒杀操作</li>
</ul>
<p>一个最基本的秒杀系统应该拥有的功能已经分析完毕，下面进行具体代码的编写。</p>
<h2 id="4-2-Service-层涉及代码编写"><a href="#4-2-Service-层涉及代码编写" class="headerlink" title="4.2 Service 层涉及代码编写"></a>4.2 Service 层涉及代码编写</h2><p>先创建出需要的项目目录结构，用以存放我们的代码。</p>
<p><img data-src="https://i.loli.net/2021/02/22/dRWmzSPNOih8MKq.png" alt="image-20210222102455694"></p>
<ul>
<li>DTO 包：用以存放 web 与 server 通信数据的实体类，跟 entity 中存放的类似，只不过通信的对象不一样</li>
<li>exception 包：用来存放我们自定义的异常类</li>
<li>service 包（下属创建 impl 包，用来存放接口实现类）：用来存放 service 逻辑代码</li>
</ul>
<p>在 service 包下新建 SeckillService 接口</p>
<p><code>SeckillService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.seckill.dto.Exposer;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dto.SeckillExecution;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SecKill;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.RepeatKillException;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.SeckillCloseException;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.SeckillException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 业务接口：站在使用者的角度设计接口</span></span><br><span class="line"><span class="comment"> * 如何实现站在使用者角度进行开发：</span></span><br><span class="line"><span class="comment"> * 1、方法定义粒度：也就是具体到每一个功能</span></span><br><span class="line"><span class="comment"> * 2、参数：简单明确的传递</span></span><br><span class="line"><span class="comment"> * 3、返回类型：类型友好，简单（return/异常）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SeckillService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有的秒杀库存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;SecKill&gt; <span class="title">getSeckillList</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询单个的秒杀商品</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SecKill <span class="title">getById</span><span class="params">(<span class="keyword">long</span> seckillId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 秒杀开启时输出秒杀接口，</span></span><br><span class="line"><span class="comment">     * 否则输出系统时间和秒杀时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 秒杀执行操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> md5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SeckillException, RepeatKillException, SeckillCloseException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行秒杀操作 by 存储过程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SeckillException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RepeatKillException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SeckillCloseException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SeckillExecution <span class="title">executeSeckillProcedure</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面新引入了两个数据类，因为这属于 web - server 的通信，所以将其放进 dto 包内。同时也抛出了三个自定义异常，在 exception 中编写我们的自定义异常。</p>
<p> <code>Exposer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.dto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 暴露秒杀接口 DTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exposer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 秒杀开启标识</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> exposed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// md5 加密</span></span><br><span class="line">    <span class="keyword">private</span> String md5;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商品 id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 系统时间（毫秒）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> now;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结束时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">(<span class="keyword">boolean</span> exposed, String md5, <span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">        <span class="keyword">this</span>.md5 = md5;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">(<span class="keyword">boolean</span> exposed, <span class="keyword">long</span> seckillId, <span class="keyword">long</span> now, <span class="keyword">long</span> start, <span class="keyword">long</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.now = now;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">(<span class="keyword">boolean</span> exposed, <span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Exposer&#123;"</span> +</span><br><span class="line">                <span class="string">"exposed="</span> + exposed +</span><br><span class="line">                <span class="string">", md5='"</span> + md5 + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", seckillId="</span> + seckillId +</span><br><span class="line">                <span class="string">", now="</span> + now +</span><br><span class="line">                <span class="string">", start="</span> + start +</span><br><span class="line">                <span class="string">", end="</span> + end +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExposed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exposed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExposed</span><span class="params">(<span class="keyword">boolean</span> exposed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMd5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMd5</span><span class="params">(String md5)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.md5 = md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNow</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.now = now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStart</span><span class="params">(<span class="keyword">long</span> start)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnd</span><span class="params">(<span class="keyword">long</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SeckillExecution</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SuccessKilled;</span><br><span class="line"><span class="keyword">import</span> org.seckill.enums.SeckillStatEnum;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装秒杀执行后的结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillExecution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 秒杀执行结果状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态表示</span></span><br><span class="line">    <span class="keyword">private</span> String stateInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 秒杀成功对象</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilled successKilled;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, SeckillStatEnum statEnum, SuccessKilled successKilled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.state = statEnum.getState();</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = statEnum.getStateInfo();</span><br><span class="line">        <span class="keyword">this</span>.successKilled = successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, SeckillStatEnum statEnum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.state = statEnum.getState();</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = statEnum.getStateInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SeckillExecution&#123;"</span> +</span><br><span class="line">                <span class="string">"seckillId="</span> + seckillId +</span><br><span class="line">                <span class="string">", state="</span> + state +</span><br><span class="line">                <span class="string">", stateInfo='"</span> + stateInfo + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", successKilled="</span> + successKilled +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStateInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStateInfo</span><span class="params">(String stateInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SuccessKilled <span class="title">getSuccessKilled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccessKilled</span><span class="params">(SuccessKilled successKilled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.successKilled = successKilled;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SeckillException</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.exception;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 秒杀业务异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RepeatKillException</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.exception;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重复秒杀异常（运行期异常）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatKillException</span> <span class="keyword">extends</span> <span class="title">SeckillException</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RepeatKillException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RepeatKillException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SeckillCloseException</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.exception;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 秒杀关闭异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillCloseException</span> <span class="keyword">extends</span> <span class="title">SeckillException</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillCloseException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillCloseException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-Service-接口的实现"><a href="#4-3-Service-接口的实现" class="headerlink" title="4.3 Service 接口的实现"></a>4.3 Service 接口的实现</h2><p>在实现类中我们会使用标志状态的常量数据，所以先创建一个枚举类来简化数据操作</p>
<p>新建 enums 包，在包下新建 SeckillStatEnum 枚举类</p>
<p><img data-src="https://i.loli.net/2021/02/23/C8HJROjsyYK43Qe.png" alt="image-20210223101504739"></p>
<p><code>SeckillStatEnum</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.enums;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用枚举表述常量数据字段</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SeckillStatEnum &#123;</span><br><span class="line">    SUCCESS(<span class="number">1</span>,<span class="string">"秒杀成功"</span>),</span><br><span class="line">    END(<span class="number">0</span>,<span class="string">"秒杀结束"</span>),</span><br><span class="line">    REPEAT_KILL(-<span class="number">1</span>,<span class="string">"重复秒杀"</span>),</span><br><span class="line">    INNER_ERROR(-<span class="number">2</span>,<span class="string">"系统异常"</span>),</span><br><span class="line">    DATA_REWRITE(-<span class="number">3</span>,<span class="string">"数据篡改"</span>)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String stateInfo;</span><br><span class="line"></span><br><span class="line">    SeckillStatEnum(<span class="keyword">int</span> state, String stateInfo) &#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SeckillStatEnum <span class="title">stateOf</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (SeckillStatEnum state : values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (state.getState() == index) &#123;</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStateInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStateInfo</span><span class="params">(String stateInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建好枚举类过后，下面进行实现类的编写</p>
<p><code>SeckillServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.MapUtils;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dao.SecKillDao;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dao.SuccessKilledDao;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dao.cache.RedisDao;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dto.Exposer;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dto.SeckillExecution;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SecKill;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SuccessKilled;</span><br><span class="line"><span class="keyword">import</span> org.seckill.enums.SeckillStatEnum;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.RepeatKillException;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.SeckillCloseException;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.SeckillException;</span><br><span class="line"><span class="keyword">import</span> org.seckill.service.SeckillService;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.DigestUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillServiceImpl</span> <span class="keyword">implements</span> <span class="title">SeckillService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// MD5 盐值字符串，用来混淆 MD5</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String slat = <span class="string">"njxdchviangaidjvoamv#@%#%￥%%&amp;%#%2387453"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进行 Spring 注入</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecKillDao secKillDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilledDao successKilledDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;SecKill&gt; <span class="title">getSeckillList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> secKillDao.queryAll(<span class="number">0</span>, <span class="number">10</span>);	<span class="comment">// 返回从第 0 条数据开始的 10 条数据</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecKill <span class="title">getById</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> secKillDao.queryById(seckillId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        seckill = secKillDao.queryById(seckillId);	<span class="comment">// 通过传来的 id 参数获取对应的 seckill 对象</span></span><br><span class="line">        <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Date startTime = seckill.getStartTime();</span><br><span class="line">            Date endTime = seckill.getEndTime();</span><br><span class="line">            Date nowTime = <span class="keyword">new</span> Date();</span><br><span class="line">            <span class="keyword">if</span> (nowTime.getTime() &lt; startTime.getTime()</span><br><span class="line">                    || nowTime.getTime() &gt; endTime.getTime()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId, nowTime.getTime(), startTime.getTime(), endTime.getTime());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 进行md5加密,不可逆</span></span><br><span class="line">        String md5 = getMD5(seckillId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">true</span>, md5, seckillId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用存储过程完成秒杀,这里是后面的高并发优化内容，存储过程还没有创建，所以这个方法暂时是没用的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SeckillException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RepeatKillException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SeckillCloseException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckillProcedure</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (md5 == <span class="keyword">null</span> || !md5.equals(getMD5(seckillId))) &#123;</span><br><span class="line">            <span class="comment">// 当md5验证失败时，返回数据篡改异常</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.DATA_REWRITE);</span><br><span class="line">        &#125;</span><br><span class="line">        Date killTime = <span class="keyword">new</span> Date();</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"seckillId"</span>, seckillId);</span><br><span class="line">        map.put(<span class="string">"phone"</span>, userPhone);</span><br><span class="line">        map.put(<span class="string">"killTime"</span>, killTime);</span><br><span class="line">        map.put(<span class="string">"result"</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 存储过程执行完毕，result被赋值</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            secKillDao.killByProcedure(map);</span><br><span class="line">            <span class="comment">// 获取result</span></span><br><span class="line">            Integer result = MapUtils.getInteger(map, <span class="string">"result"</span>, -<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">                SuccessKilled sk = successKilledDao.queryByIdWithSecKill(seckillId, userPhone);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.SUCCESS, sk);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.stateOf(result));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用注解控制事务方法 的优点：</span></span><br><span class="line"><span class="comment">     * 1：开发团队达成一致的约定，明确标注事务方法的编程风格</span></span><br><span class="line"><span class="comment">     * 2：保证事务方法的执行时间尽可能的短，不要穿插其他的网络操作或者剥离到事务方法外</span></span><br><span class="line"><span class="comment">     * 3：不是所有的方法都需要事务，如果只有一条修改操作，或者只有只读操作不需要事务控制</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span> <span class="keyword">throws</span> SeckillException, RepeatKillException, SeckillCloseException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (md5 == <span class="keyword">null</span> || !md5.equals(getMD5(seckillId))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SeckillException(<span class="string">"seckill data rewrite"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行秒杀业务逻辑：减库存 + 记录购买行为</span></span><br><span class="line">        Date nowTime = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 记录购买行为</span></span><br><span class="line">            <span class="keyword">int</span> insertCount = successKilledDao.insertSuccessKilled(seckillId, userPhone);</span><br><span class="line">            <span class="comment">// 唯一：seckillId , userPhone</span></span><br><span class="line">            <span class="keyword">if</span> (insertCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 重复秒杀</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RepeatKillException(<span class="string">"seckill repeated"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 热点商品竞争</span></span><br><span class="line">                <span class="keyword">int</span> updateCount = secKillDao.reduceNumber(seckillId, nowTime);</span><br><span class="line">                <span class="keyword">if</span> (updateCount &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 没有更新到记录,秒杀结束</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SeckillCloseException(<span class="string">"seckill is closed"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 秒杀成功</span></span><br><span class="line">                    SuccessKilled successKilled = successKilledDao.queryByIdWithSecKill(seckillId, userPhone);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.SUCCESS, successKilled);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SeckillCloseException e1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e1;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RepeatKillException e2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">            <span class="comment">// 所有编译器异常转化为运行期异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SeckillException(<span class="string">"seckill inner error "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getMD5</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        String base = seckillId + <span class="string">"/"</span> + slat;</span><br><span class="line">        String md5 = DigestUtils.md5DigestAsHex(base.getBytes());</span><br><span class="line">        <span class="keyword">return</span> md5;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-4-使用-Spring-进行依赖注入"><a href="#4-4-使用-Spring-进行依赖注入" class="headerlink" title="4.4 使用 Spring 进行依赖注入"></a>4.4 使用 Spring 进行依赖注入</h2><p>在 spring 的配置文件夹中新建一个配置文件 spring-service.xml</p>
<p><code>spring-service.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置对 service 包下的所有类进行包扫描 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.seckill.service"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  配置声明式事务管理器  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  注入数据库连接池，在Spring读取配置文件时会导入    --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置基于注解的声明式事务</span></span><br><span class="line"><span class="comment">            默认使用注解来管理事务行为--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-5-进行单元测试"><a href="#4-5-进行单元测试" class="headerlink" title="4.5 进行单元测试"></a>4.5 进行单元测试</h2><p>进行单元测试之前，先配置一下 logback （这里只做简单的配置，如果想要了解更加详细的配置可以转到官方文档了解 <a href="https://github.com/YLongo/logback-chinese-manual" target="_blank" rel="noopener">Logback 中文文档</a>）</p>
<p><img data-src="https://i.loli.net/2021/02/23/2DYqw7NU8lGIEZO.png" alt="image-20210223105957029"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"debug"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>生成测试类 SeckillServiceIpmlTest</p>
<p><code>SeckillServiceIpmlTest</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dto.Exposer;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dto.SeckillExecution;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SecKill;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.RepeatKillException;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.SeckillCloseException;</span><br><span class="line"><span class="keyword">import</span> org.seckill.service.SeckillService;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ContextConfiguration</span>(</span>&#123;<span class="string">"classpath:spring/spring-dao.xml"</span>,</span><br><span class="line">        <span class="string">"classpath:spring/spring-service.xml"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillService seckillService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSeckillList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;SecKill&gt; list = seckillService.getSeckillList();</span><br><span class="line">        logger.info(<span class="string">"list = &#123;&#125;"</span>, list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> id = <span class="number">1000</span>;</span><br><span class="line">        SecKill secKill = seckillService.getById(id);</span><br><span class="line">        logger.info(<span class="string">"seckill = &#123;&#125;"</span>, secKill);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Exposer&#123;exposed=true,</span></span><br><span class="line"><span class="comment">     * md5='81c003e266701ca48287cd4c588fcac8',</span></span><br><span class="line"><span class="comment">     * seckillId=1002,</span></span><br><span class="line"><span class="comment">     * now=0,</span></span><br><span class="line"><span class="comment">     * start=0,</span></span><br><span class="line"><span class="comment">     * end=0&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exportSeckillUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> id = <span class="number">1003</span>;</span><br><span class="line">        Exposer exposer = seckillService.exportSeckillUrl(id);</span><br><span class="line">        <span class="keyword">if</span> (exposer.isExposed()) &#123;</span><br><span class="line">            <span class="keyword">long</span> phone = xxxxxxxx;</span><br><span class="line">            String md5 = exposer.getMd5();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                SeckillExecution execution = seckillService.executeSeckill(id, phone, md5);</span><br><span class="line">                logger.info(<span class="string">"result=&#123;&#125;"</span>, execution);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RepeatKillException e) &#123;</span><br><span class="line">                logger.error(e.getMessage());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SeckillCloseException e) &#123;</span><br><span class="line">                logger.error(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 秒杀未开启</span></span><br><span class="line">            logger.warn(<span class="string">"exposer = &#123;&#125;"</span>, exposer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeSeckillProcedure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId = <span class="number">1002</span>;</span><br><span class="line">        <span class="keyword">long</span> phone = xxxxxxxxx;</span><br><span class="line">        Exposer exposer = seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (exposer.isExposed()) &#123;</span><br><span class="line">            String md5 = exposer.getMd5();</span><br><span class="line">            SeckillExecution execution = seckillService.executeSeckillProcedure(seckillId, phone, md5);</span><br><span class="line">            logger.info(execution.getStateInfo());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Test</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * result=SeckillExecution&#123;</span></span><br><span class="line"><span class="comment">     * seckillId=1002,</span></span><br><span class="line"><span class="comment">     * state=1,</span></span><br><span class="line"><span class="comment">     * stateInfo='秒杀成功',</span></span><br><span class="line"><span class="comment">     * successKilled=SuccessKilled&#123;secKillId=1002,</span></span><br><span class="line"><span class="comment">     * userPhone=xxxxxxxxx,</span></span><br><span class="line"><span class="comment">     * state=-1,</span></span><br><span class="line"><span class="comment">     * createTime=Tue Jan 26 23:16:53 CST 2021&#125;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    public void executeSeckill() &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单元测试通过后，进入web 层的开发。</p>
<h1 id="五、WEB-层的开发"><a href="#五、WEB-层的开发" class="headerlink" title="五、WEB 层的开发"></a>五、WEB 层的开发</h1><h2 id="5-1-web-层的设计"><a href="#5-1-web-层的设计" class="headerlink" title="5.1 web 层的设计"></a>5.1 web 层的设计</h2><p>web 层对应的是项目中的前端，本秒杀系统设计到的知识主要有以下几点</p>
<p><img data-src="https://i.loli.net/2021/02/23/YXWBnsmxtb4qTKu.png" alt="image-20210223112141332"></p>
<ul>
<li><a href="https://www.cnblogs.com/zuanzuan/p/10414800.html" target="_blank" rel="noopener">Restful 规范</a></li>
</ul>
<p><img data-src="https://i.loli.net/2021/02/23/B8P5lrb6JAy3qtS.png" alt="image-20210223151937456"></p>
<ul>
<li><a href="https://blog.csdn.net/litianxiang_kaola/article/details/79169148" target="_blank" rel="noopener">SpringMVC</a> </li>
<li><a href="https://v3.bootcss.com/" target="_blank" rel="noopener">bootstrap</a></li>
</ul>
<p>web 层的流程逻辑</p>
<p><img data-src="https://i.loli.net/2021/02/23/NCsdPFEOSb4ZBMR.png" alt="image-20210223113332922"></p>
<h2 id="5-2-SpringMVC-的配置"><a href="#5-2-SpringMVC-的配置" class="headerlink" title="5.2 SpringMVC 的配置"></a>5.2 SpringMVC 的配置</h2><p>在 webapp 文件夹下创建 web.xml 配置文件</p>
<p><code>web.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee            http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置 DispatcherServlet --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>seckill-dispatcher<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--   配置 SpringMVC 需要加载的配置文件</span></span><br><span class="line"><span class="comment">                spring-dao.xml,spring-server.xml,spring-web.xml</span></span><br><span class="line"><span class="comment">                整合顺序：Mybatis -&gt; Spring -&gt; springMVC  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring/spring-*.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>seckill-dispatcher<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 默认匹配所有的请求 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 spring 的配置文件夹下创建 spring-web.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置 SpringMVC  --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  1：开启SpringMVC注解模式</span></span><br><span class="line"><span class="comment">            简化配置：</span></span><br><span class="line"><span class="comment">              （1）自动注册 DefaultAnnotationHandlerMapping , AnnotationMethodHandlerAdapter</span></span><br><span class="line"><span class="comment">              （2）默认提供了一系列功能：数据绑定，数字和日期的格式化format @NumberFormat,@DataTimeFormat,</span></span><br><span class="line"><span class="comment">                    xml,json 默认读写支持--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--  servlet-mapping 映射路径："/"</span></span><br><span class="line"><span class="comment">            静态资源默认servlet配置</span></span><br><span class="line"><span class="comment">                1：加入对静态资源的处理：js,gif,png</span></span><br><span class="line"><span class="comment">                2：允许使用“/”做整体处理--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 3：配置jsp，显示ViewResolver --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"viewClass"</span> <span class="attr">value</span>=<span class="string">"org.springframework.web.servlet.view.JstlView"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  4：扫描web相关的bean  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.seckill.web"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-使用-SpringMVC-实现-Restful-接口"><a href="#5-3-使用-SpringMVC-实现-Restful-接口" class="headerlink" title="5.3 使用 SpringMVC 实现 Restful 接口"></a>5.3 使用 SpringMVC 实现 Restful 接口</h2><p>新建一个 web 包，用来存放 spring 的 Controller 类</p>
<p><img data-src="https://i.loli.net/2021/02/23/DFUOBRMuCGPwXWL.png" alt="image-20210223152451131"></p>
<p><code>SeckillController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.seckill.dto.Exposer;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dto.SeckillExecution;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dto.SeckillResult;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SecKill;</span><br><span class="line"><span class="keyword">import</span> org.seckill.enums.SeckillStatEnum;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.RepeatKillException;</span><br><span class="line"><span class="keyword">import</span> org.seckill.exception.SeckillCloseException;</span><br><span class="line"><span class="keyword">import</span> org.seckill.service.SeckillService;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="comment">//@RequestMapping(value = "/seckill/")// url:/模块/资源/&#123;id&#125;/细分 /seckill/list</span></span><br><span class="line"><span class="comment">// 这里写在越外面的 @RequestMapping 在构成的 url 越靠前</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillService seckillService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/list"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">list</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取列表页</span></span><br><span class="line">        List&lt;SecKill&gt; list = seckillService.getSeckillList();</span><br><span class="line">        model.addAttribute(<span class="string">"list"</span>, list);</span><br><span class="line">        <span class="comment">//list.jsp + model = ModelAndView</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"list"</span>; <span class="comment">// /WEB-INF/jsp/"list".jsp</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;secKillId&#125;/detail"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">detail</span><span class="params">(@PathVariable(<span class="string">"secKillId"</span>)</span> Long seckillId, Model model) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (seckillId == <span class="keyword">null</span>) &#123;	<span class="comment">// 当id不存在时，直接重定向到 list 页</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/list"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        SecKill secKill = seckillService.getById(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (secKill == <span class="keyword">null</span>) &#123;	<span class="comment">// 当id对应的 seckill 对象不存在时，将请求转发到 list </span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"forward:/list"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">"secKill"</span>, secKill); <span class="comment">// 返回数据 model</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"detail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ajax json</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;seckillId&#125;/exposer"</span>,</span><br><span class="line">            method = RequestMethod.POST,</span><br><span class="line">            produces = &#123;<span class="string">"application/json;charset=UTF-8"</span>&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;Exposer&gt; <span class="title">exposer</span><span class="params">(@PathVariable(<span class="string">"seckillId"</span>)</span> Long seckillId) </span>&#123;</span><br><span class="line">        SeckillResult&lt;Exposer&gt; result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Exposer exposer = seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">            result = <span class="keyword">new</span> SeckillResult&lt;Exposer&gt;(<span class="keyword">true</span>, exposer); <span class="comment">// 对应 state,exposer 构造器</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">            result = <span class="keyword">new</span> SeckillResult&lt;Exposer&gt;(<span class="keyword">false</span>, e.getMessage()); <span class="comment">// 对应 state,error 构造器</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;seckillId&#125;/&#123;md5&#125;/execution"</span>,</span><br><span class="line">            method = RequestMethod.POST,</span><br><span class="line">            produces = &#123;<span class="string">"application/json;charset=UTF-8"</span>&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span> <span class="comment">// 告诉 Spring 将结果封装成 json</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;SeckillExecution&gt; <span class="title">execute</span><span class="params">(@PathVariable(<span class="string">"seckillId"</span>)</span> Long seckillId,</span></span><br><span class="line"><span class="function">                                                   @<span class="title">PathVariable</span><span class="params">(<span class="string">"md5"</span>)</span> String md5,</span></span><br><span class="line"><span class="function">                                                   @<span class="title">CookieValue</span><span class="params">(value = <span class="string">"killPhone"</span>, required = <span class="keyword">false</span>)</span> Long phone) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (phone == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>, <span class="string">"未注册"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SeckillResult&lt;SeckillExecution&gt; result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SeckillExecution execution = seckillService.executeSeckill(seckillId, phone, md5);</span><br><span class="line">            <span class="comment">// 启用存储过程处理</span></span><br><span class="line">            <span class="comment">//SeckillExecution execution = seckillService.executeSeckillProcedure(seckillId, phone, md5);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">true</span>, execution);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SeckillCloseException e) &#123;</span><br><span class="line">            SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.END);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RepeatKillException e) &#123;</span><br><span class="line">            SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.REPEAT_KILL);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">            SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/time/now"</span>,method = RequestMethod.GET)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;Long&gt; <span class="title">time</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Date now = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult(<span class="keyword">true</span>,now.getTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 DTO 包下新建一个 Result 类，用来封装 json 的数据</p>
<p><code>SeckillResult</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.dto;</span><br><span class="line"><span class="comment">//所有的 ajax 请求返回类型，封装 json 结果</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillResult</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String error;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillResult</span><span class="params">(<span class="keyword">boolean</span> success, String error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">        <span class="keyword">this</span>.error = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillResult</span><span class="params">(<span class="keyword">boolean</span> success, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccess</span><span class="params">(<span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(String error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.error = error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-4-使用-bootstrap-开发页面"><a href="#5-4-使用-bootstrap-开发页面" class="headerlink" title="5.4 使用 bootstrap 开发页面"></a>5.4 使用 bootstrap 开发页面</h2><p><a href="https://www.bootcdn.cn/" target="_blank" rel="noopener">Boot CDN</a> Bootstrap 的 API 地址</p>
<p><a href="https://www.bootcss.com/" target="_blank" rel="noopener">Bootstrap 官网</a></p>
<p><a href="https://www.runoob.com/bootstrap/bootstrap-environment-setup.html" target="_blank" rel="noopener">Bootstrap 菜鸟教程</a></p>
<p>Bootstrap 的页面开发就是使用他提供的各种 API 进行简单代码编写的过程，如果想要更加深层次的理解，可以参见以上的三个网站，这里只贴出系统需要的代码</p>
<p><img data-src="https://i.loli.net/2021/02/23/gEzyX7KAImhwGN1.png" alt="image-20210223161844464"></p>
<p>如图新建文件，common 中存放的各 jsp 文件共用的部分</p>
<p><code>head.jsp</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: <span class="number">23720</span></span><br><span class="line">  Date: <span class="number">2021</span>/<span class="number">1</span>/<span class="number">27</span></span><br><span class="line">  Time: <span class="number">16</span>:<span class="number">03</span></span><br><span class="line">  To change <span class="keyword">this</span> template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"X-UA-Compatible"</span> content=<span class="string">"IE=edge"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span><br><span class="line">    &lt;!-- 上述<span class="number">3</span>个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Bootstrap --&gt;</span><br><span class="line">    &lt;link href=<span class="string">"https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 --&gt;</span><br><span class="line">    &lt;!-- 警告：通过 file:<span class="comment">// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 --&gt;</span></span><br><span class="line">    &lt;!--[<span class="keyword">if</span> lt IE <span class="number">9</span>]&gt;</span><br><span class="line">    &lt;script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;![endif]--&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><code>tag.jsp</code></p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fmt"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/fmt"</span> %&gt;</span><br></pre></td></tr></table></figure>

<p><code>detail.jsp</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"zh-CN"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;秒杀详情页&lt;/title&gt;</span><br><span class="line">    &lt;%<span class="meta">@include</span> file=<span class="string">"common/head.jsp"</span> %&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"container"</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel panel-default text-center"</span>&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-heading"</span>&gt;</span><br><span class="line">            &lt;h1&gt;$&#123;secKill.name&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-body"</span>&gt;</span><br><span class="line">        &lt;h2 <span class="class"><span class="keyword">class</span></span>=<span class="string">"text-danger text-center"</span>&gt;</span><br><span class="line">            &lt;%--                显示time图标--%&gt;</span><br><span class="line">            &lt;span class="glyphicon glyphicon-time"&gt;&lt;/span&gt;</span><br><span class="line">            &lt;%--                显示倒计时--%&gt;</span><br><span class="line">            &lt;span class="glyphicon" id="seckill-box"&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;%--    登陆弹出框，输入电话--%&gt;</span><br><span class="line">&lt;div id=<span class="string">"killPhoneModal"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal fade"</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-dialog"</span>&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-content"</span>&gt;</span><br><span class="line">            &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-header"</span>&gt;</span><br><span class="line">                &lt;h3 <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-title text-center"</span>&gt;</span><br><span class="line">                    &lt;span class="glyphicon glyphicon-phone"&gt;秒杀电话&lt;/span&gt;</span><br><span class="line">                &lt;/h3&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-body"</span>&gt;</span><br><span class="line">                &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"row"</span>&gt;</span><br><span class="line">                    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"col-xs-8 col-xs-offset-2"</span>&gt;</span><br><span class="line">                        &lt;input type=<span class="string">"text"</span> name=<span class="string">"killPhone"</span> id=<span class="string">"killPhoneKey"</span></span><br><span class="line">                               placeholder=<span class="string">"填手机号"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"from-control"</span>/&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-footer"</span>&gt;</span><br><span class="line">                &lt;%--验证信息--%&gt;</span><br><span class="line">                &lt;span id="killPhoneMessage" class="glyphicon"&gt;&lt;/span&gt;</span><br><span class="line">                &lt;button type=<span class="string">"button"</span> id=<span class="string">"killPhoneBtn"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"btn btn-success"</span>&gt;</span><br><span class="line">                    &lt;span class="glyphicon glyphicon-phone"&gt;&lt;/span&gt;</span><br><span class="line">                    submit</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;!-- 新 Bootstrap 核心 CSS 文件 --&gt;</span><br><span class="line">&lt;link href=<span class="string">"https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">&lt;!-- jQuery文件。务必在bootstrap.min.js 之前引入 --&gt;</span><br><span class="line">&lt;script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 最新的 Bootstrap 核心 JavaScript 文件 --&gt;</span><br><span class="line">&lt;script src="https://cdn.staticfile.org/twitter-bootstrap/3.4.0/js/bootstrap.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;%--jQuery cookie操作插件--%&gt;</span><br><span class="line">&lt;script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;%--jQuery countDown倒计时插件--%&gt;</span><br><span class="line">&lt;script src="https://cdn.bootcss.com/jquery.countdown/2.2.0/jquery.countdown.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;%-- 交互逻辑 --%&gt;</span><br><span class="line">&lt;script src="/seckill/resources/script/seckill.js" type="text/javascript"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    $(function () &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用EL表达式传入参数</span></span><br><span class="line">        seckill.detail.init(&#123;</span><br><span class="line">            <span class="comment">// 使用EL表达式传入参数</span></span><br><span class="line">            seckillId: $&#123;secKill.secKillId&#125;,</span><br><span class="line">            startTime: $&#123;secKill.startTime.time&#125;,<span class="comment">//毫秒时间</span></span><br><span class="line">            endTime: $&#123;secKill.endTime.time&#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><code>list.jsp</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%-- 引入 jstl --%&gt;</span><br><span class="line">&lt;%<span class="meta">@include</span> file=<span class="string">"common/tag.jsp"</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"zh-CN"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;秒杀列表页&lt;/title&gt;</span><br><span class="line">    &lt;%<span class="meta">@include</span> file=<span class="string">"common/head.jsp"</span>%&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%-- 页面显示部分 --%&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"container"</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel panel-default"</span>&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-heading text-center"</span>&gt;</span><br><span class="line">            &lt;h2&gt;秒杀列表&lt;/h2&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-body"</span>&gt;</span><br><span class="line">            &lt;table <span class="class"><span class="keyword">class</span></span>=<span class="string">"table table-hover"</span>&gt;</span><br><span class="line">                &lt;thead&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;th&gt;名称&lt;/th&gt;</span><br><span class="line">                    &lt;th&gt;库存&lt;/th&gt;</span><br><span class="line">                    &lt;th&gt;开启时间&lt;/th&gt;</span><br><span class="line">                    &lt;th&gt;结束时间&lt;/th&gt;</span><br><span class="line">                    &lt;th&gt;创建时间&lt;/th&gt;</span><br><span class="line">                    &lt;th&gt;详情页&lt;/th&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">                &lt;/thead&gt;</span><br><span class="line">                &lt;tbody&gt;</span><br><span class="line">                &lt;c:forEach <span class="keyword">var</span>=<span class="string">"sk"</span> items=<span class="string">"$&#123;list&#125;"</span>&gt;</span><br><span class="line">                    &lt;tr&gt;</span><br><span class="line">                        &lt;td&gt;$&#123;sk.name&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;$&#123;sk.number&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;</span><br><span class="line">                            &lt;fmt:formatDate value="$&#123;sk.startTime&#125;" pattern="yyyy-MM-dd HH:mm:ss"&gt;&lt;/fmt:formatDate&gt;</span><br><span class="line">                        &lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;</span><br><span class="line">                            &lt;fmt:formatDate value="$&#123;sk.endTime&#125;" pattern="yyyy-MM-dd HH:mm:ss"&gt;&lt;/fmt:formatDate&gt;</span><br><span class="line">                        &lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;</span><br><span class="line">                            &lt;fmt:formatDate value="$&#123;sk.createTime&#125;" pattern="yyyy-MM-dd HH:mm:ss"&gt;&lt;/fmt:formatDate&gt;</span><br><span class="line">                        &lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;</span><br><span class="line">                            &lt;a class="btn btn-info" href="/seckill/$&#123;sk.secKillId&#125;/detail" &gt;link&lt;/a&gt; &lt;!-- target="_blank" --&gt;</span><br><span class="line">                        &lt;/td&gt;</span><br><span class="line">                    &lt;/tr&gt;</span><br><span class="line">                &lt;/c:forEach&gt;</span><br><span class="line">                &lt;/tbody&gt;</span><br><span class="line">            &lt;/table&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- jQuery文件。务必在bootstrap.min.js 之前引入 --&gt;</span><br><span class="line">&lt;script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 最新的 Bootstrap 核心 JavaScript 文件 --&gt;</span><br><span class="line">&lt;script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"&gt;&lt;/script&gt;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><code>seckill.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存放主要的交互逻辑</span></span><br><span class="line"><span class="comment">// JavaScript 模块化</span></span><br><span class="line"><span class="keyword">var</span> seckill = &#123;</span><br><span class="line">    <span class="comment">// 封装秒杀相关的ajax的url</span></span><br><span class="line">    URL: &#123;</span><br><span class="line">        now: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'/seckill/time/now'</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        exposer: <span class="function"><span class="keyword">function</span> (<span class="params">seckillId</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'/seckill/'</span> + seckillId + <span class="string">'/exposer'</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        execution: <span class="function"><span class="keyword">function</span> (<span class="params">seckillId, md5</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'/seckill/'</span> + seckillId + <span class="string">'/'</span> + md5 + <span class="string">'/execution'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 验证手机号</span></span><br><span class="line">    validatePhone: <span class="function"><span class="keyword">function</span> (<span class="params">phone</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (phone &amp;&amp; phone.length == <span class="number">11</span> &amp;&amp; !<span class="built_in">isNaN</span>(phone)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleSeckillkill: <span class="function"><span class="keyword">function</span> (<span class="params">seckillId,node</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 处理秒杀逻辑：获取秒杀地址，控制显示逻辑，执行秒杀</span></span><br><span class="line">        node.hide().html(<span class="string">'&lt;button class="btn btn-primary btn-lg" id="killBtn"&gt;开始秒杀&lt;/button&gt;'</span>);<span class="comment">//按钮</span></span><br><span class="line">        $.post(seckill.URL.exposer(seckillId), &#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 在回调函数中，执行交互流程</span></span><br><span class="line">            <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">'success'</span>]) &#123;</span><br><span class="line">                <span class="keyword">var</span> exposer = result[<span class="string">'data'</span>];</span><br><span class="line">                <span class="keyword">if</span> (exposer[<span class="string">'exposed'</span>]) &#123;</span><br><span class="line">                    <span class="comment">// 开启</span></span><br><span class="line">                    <span class="comment">// 获取地址</span></span><br><span class="line">                    <span class="keyword">var</span> md5 = exposer[<span class="string">'md5'</span>];</span><br><span class="line">                    <span class="keyword">var</span> killUrl = seckill.URL.execution(seckillId, md5);</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'killUrl:'</span> + killUrl);<span class="comment">//TODO</span></span><br><span class="line">                    <span class="comment">// 绑定一次点击事件</span></span><br><span class="line">                    $(<span class="string">'#killBtn'</span>).one(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                        <span class="comment">// 绑定了执行秒杀的操作</span></span><br><span class="line">                        <span class="comment">//1：禁用按钮</span></span><br><span class="line">                        $(<span class="keyword">this</span>).addClass(<span class="string">'disabled'</span>);</span><br><span class="line">                        <span class="comment">// 2：发送秒杀请求</span></span><br><span class="line">                        $.post(killUrl, &#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">'success'</span>]) &#123;</span><br><span class="line">                                <span class="keyword">var</span> killResult = result[<span class="string">'data'</span>];</span><br><span class="line">                                <span class="keyword">var</span> state = killResult[<span class="string">'state'</span>];</span><br><span class="line">                                <span class="keyword">var</span> stateInfo = killResult[<span class="string">'stateInfo'</span>];</span><br><span class="line">                                <span class="comment">// 显示秒杀结果</span></span><br><span class="line">                                node.html(<span class="string">'&lt;span class="label label-success"&gt;'</span> + stateInfo + <span class="string">'&lt;/span&gt;'</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;);</span><br><span class="line">                    node.show();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 未开启</span></span><br><span class="line">                    <span class="keyword">var</span> now = exposer[<span class="string">'now'</span>];</span><br><span class="line">                    <span class="keyword">var</span> start = exposer[<span class="string">'start'</span>];</span><br><span class="line">                    <span class="keyword">var</span> end = exposer[<span class="string">'end'</span>];</span><br><span class="line">                    <span class="comment">// 重新计算计时逻辑</span></span><br><span class="line">                    seckill.countDown(seckillId, now, start, end);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'result:'</span> + result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 时间判断</span></span><br><span class="line">    countDown: <span class="function"><span class="keyword">function</span> (<span class="params">seckillId, nowTime, startTime, endTime</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> seckillBox = $(<span class="string">'#seckill-box'</span>);</span><br><span class="line">        <span class="comment">// 时间判断</span></span><br><span class="line">        <span class="keyword">if</span> (nowTime &gt; endTime) &#123;</span><br><span class="line">            <span class="comment">// 秒杀结束</span></span><br><span class="line">            seckillBox.html(<span class="string">'秒杀结束'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nowTime &lt; startTime) &#123;</span><br><span class="line">            <span class="comment">// 秒杀未开始,计时事件绑定</span></span><br><span class="line">            <span class="keyword">var</span> killTime = <span class="keyword">new</span> <span class="built_in">Date</span>(startTime + <span class="number">1000</span>);</span><br><span class="line">            seckillBox.countdown(killTime, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 时间格式</span></span><br><span class="line">                <span class="keyword">var</span> format = event.strftime(<span class="string">'秒杀倒计时：%D天 %H时 %M分 %S秒'</span>);</span><br><span class="line">                seckillBox.html(format);</span><br><span class="line">                <span class="comment">// 时间完成后调用事件</span></span><br><span class="line">            &#125;).on(<span class="string">'finish.countdown'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 获取秒杀地址，控制现实逻辑</span></span><br><span class="line">                seckill.handleSeckillkill(seckillId,seckillBox);</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 秒杀开始</span></span><br><span class="line">            seckill.handleSeckillkill(seckillId,seckillBox);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 详情页秒杀逻辑</span></span><br><span class="line">    detail: &#123;</span><br><span class="line">        <span class="comment">// 详情页初始化</span></span><br><span class="line">        init: <span class="function"><span class="keyword">function</span> (<span class="params">params</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 通过手机验证和登录，计时交互</span></span><br><span class="line">            <span class="comment">// 规划交互流程</span></span><br><span class="line">            <span class="comment">// 在cookie中查找手机号</span></span><br><span class="line">            <span class="keyword">var</span> killPhone = $.cookie(<span class="string">'killPhone'</span>);</span><br><span class="line">            <span class="comment">// 验证手机号</span></span><br><span class="line">            <span class="keyword">if</span> (!seckill.validatePhone(killPhone)) &#123;</span><br><span class="line">                <span class="comment">// 绑定手机号</span></span><br><span class="line">                <span class="comment">// 控制输出</span></span><br><span class="line">                <span class="keyword">var</span> killPhoneModal = $(<span class="string">'#killPhoneModal'</span>);</span><br><span class="line">                <span class="comment">//显示弹出层</span></span><br><span class="line">                killPhoneModal.modal(&#123;</span><br><span class="line">                    show: <span class="literal">true</span>, <span class="comment">// 显示弹出层</span></span><br><span class="line">                    backdrop: <span class="string">'static'</span>,<span class="comment">//禁止位置关闭</span></span><br><span class="line">                    keyboard: <span class="literal">false</span>, <span class="comment">// 关闭键盘事件</span></span><br><span class="line">                &#125;);</span><br><span class="line">                $(<span class="string">'#killPhoneBtn'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="keyword">var</span> inputPhone = $(<span class="string">'#killPhoneKey'</span>).val();</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'inputPhone='</span> + inputPhone);<span class="comment">//TODO</span></span><br><span class="line">                    <span class="keyword">if</span> (seckill.validatePhone(inputPhone)) &#123;</span><br><span class="line">                        <span class="comment">// 电话写入cookie</span></span><br><span class="line">                        $.cookie(<span class="string">'killPhone'</span>, inputPhone, &#123;<span class="attr">expiress</span>: <span class="number">7</span>, <span class="attr">path</span>: <span class="string">'/seckill'</span>&#125;);</span><br><span class="line">                        <span class="comment">// 刷新页面</span></span><br><span class="line">                        <span class="built_in">window</span>.location.reload();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        $(<span class="string">'#killPhoneMessage'</span>).hide().html(<span class="string">'&lt;lable class="label label-danger"&gt;手机号错误！&lt;/lable&gt;'</span>).show(<span class="number">300</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 已经登录</span></span><br><span class="line">            <span class="comment">// 计时交互</span></span><br><span class="line">            <span class="keyword">var</span> startTime = params[<span class="string">'startTime'</span>];</span><br><span class="line">            <span class="keyword">var</span> endTime = params[<span class="string">'endTime'</span>];</span><br><span class="line">            <span class="keyword">var</span> seckillId = params[<span class="string">'seckillId'</span>];</span><br><span class="line">            $.<span class="keyword">get</span>(seckill.URL.now(), &#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">'success'</span>]) &#123;</span><br><span class="line">                    <span class="keyword">var</span> nowTime = result[<span class="string">'data'</span>];</span><br><span class="line">                    <span class="comment">// 时间判断</span></span><br><span class="line">                    seckill.countDown(seckillId, nowTime, startTime, endTime);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'result:'</span> + result)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-5-Tomcat-的配置和项目的部署"><a href="#5-5-Tomcat-的配置和项目的部署" class="headerlink" title="5.5 Tomcat 的配置和项目的部署"></a>5.5 Tomcat 的配置和项目的部署</h2><p>首先在本地安装 Tomcat </p>
<p><img data-src="https://i.loli.net/2021/02/23/poi2fQnE7JlRxs3.png" alt="image-20210223164822339"></p>
<p>编辑配置</p>
<p><img data-src="https://i.loli.net/2021/02/23/4YVgj2zt86sCHKn.png" alt="image-20210223164908025"></p>
<p>进行 Tomcat 的配置</p>
<p><img data-src="https://i.loli.net/2021/02/23/TUgYoaR4Q8sDM69.png" alt="image-20210223165027229"></p>
<p><img data-src="https://i.loli.net/2021/02/23/M4vdJHsSgyOYjRx.png" alt="image-20210223165308023"></p>
<p>配置完毕过后就可以尝试 run 一下了，但在之前要检查自己相关的服务是否开启</p>
<p>运行结果应当如图</p>
<p><img data-src="https://i.loli.net/2021/02/23/IiGwvyCDuWZeM6O.png" alt="image-20210223165655018"></p>
<p>点击 link</p>
<p><img data-src="https://i.loli.net/2021/02/23/F831j9dsWfRcANq.png" alt="image-20210223165726094"></p>
<p>对秒杀结束商品</p>
<p><img data-src="https://i.loli.net/2021/02/23/Wao1dD9uH7Cl8UJ.png" alt="image-20210223165755861"></p>
<p>对正在秒杀商品</p>
<p><img data-src="https://i.loli.net/2021/02/23/Bfm4UnSiax9ukho.png" alt="image-20210223165816522"></p>
<p>点击秒杀按钮</p>
<p><img data-src="https://i.loli.net/2021/02/23/PKLl3o6kzC4dNgm.png" alt="image-20210223165832926"></p>
<p>重复秒杀</p>
<p><img data-src="https://i.loli.net/2021/02/23/8fWPK4NRIEAamTw.png" alt="image-20210223165944936"></p>
<p>并且可以查询到数据库相应商品数量 -1</p>
<p>下面进行高并发优化</p>
<h1 id="六、高并发优化"><a href="#六、高并发优化" class="headerlink" title="六、高并发优化"></a>六、高并发优化</h1><h2 id="6-1-高并发发生点分析"><a href="#6-1-高并发发生点分析" class="headerlink" title="6.1 高并发发生点分析"></a>6.1 高并发发生点分析</h2><p>从用户操作的发生过程分析，可能出现高并发的地方（红色高亮）</p>
<p><img data-src="https://i.loli.net/2021/02/24/fljPVGkFqoZRMb6.png" alt="image-20210224155051373"></p>
<ol>
<li><p>详情页：详情页展示的是我们的商品信息（商品名、数量、价格、秒杀链接），在详情页中用户大量高频的刷新行为会导致频繁的访问系统资源，给系统带来极大的负担。这里采用 CDN 来缓解用户的高频访问。</p>
<p><a href="https://www.jianshu.com/p/ce98fbff39ac" target="_blank" rel="noopener">什么是 CDN </a></p>
</li>
<li><p>系统时间：系统访问一次内存大概需要 10 ns ,这是一个很短的时间，不会影响到系统的正常运行，故不需要优化。</p>
</li>
<li><p>秒杀接口：当秒杀开启时，大量的对商品的操作请求会涌入服务器，服务器就会去获取相应的对象，但每次都去访问数据库显然会造成很大的负担。这里我们采用 Redis 来进行优化</p>
<p><a href="https://www.redis.net.cn/tutorial/3502.html" target="_blank" rel="noopener">Redis 中文文档</a></p>
</li>
<li><p>秒杀操作</p>
</li>
</ol>
<h2 id="6-2-详情页高并发优化"><a href="#6-2-详情页高并发优化" class="headerlink" title="6.2 详情页高并发优化"></a>6.2 详情页高并发优化</h2><p>在详情页中用户大量高频的刷新行为会导致频繁的访问系统资源，给系统带来极大的负担。这里采用 CDN 来缓解用户的高频访问。</p>
<p><img data-src="https://i.loli.net/2021/02/24/Wt7GKZybLwUgYuJ.png" alt="image-20210224155820967"></p>
<p>对于 CDN 来说，当用户访问特定的资源时，他是去访问 CDN 服务器，而不是来访问我们的后端服务器，这样可以很好的将用户的访问分流出去，减少后端服务器的负担。一般来说公司会去租用别人的 CDN 或者 自己搭建 CDN 服务器</p>
<p><img data-src="https://upload-images.jianshu.io/upload_images/15010945-c2467aada6631ca2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/388/format/webp" alt="img"></p>
<h2 id="6-3-秒杀地址优化"><a href="#6-3-秒杀地址优化" class="headerlink" title="6.3 秒杀地址优化"></a>6.3 秒杀地址优化</h2><p>秒杀地址会随着时间的变更而变更——当秒杀未开始得时候返回的地址跟开始了返回的地址是不一样的，是动态更新的，这样的数据我们不能使用 CDN 的方式来优化访问。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获取秒杀链接的方法</span></span><br><span class="line"><span class="comment">*/</span>    </span><br><span class="line">		<span class="function"><span class="keyword">public</span> Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        seckill = secKillDao.queryById(seckillId);	<span class="comment">// 通过传来的 id 参数获取对应的 seckill 对象</span></span><br><span class="line">        <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Date startTime = seckill.getStartTime();</span><br><span class="line">            Date endTime = seckill.getEndTime();</span><br><span class="line">            Date nowTime = <span class="keyword">new</span> Date();</span><br><span class="line">            <span class="keyword">if</span> (nowTime.getTime() &lt; startTime.getTime()</span><br><span class="line">                    || nowTime.getTime() &gt; endTime.getTime()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId, nowTime.getTime(), startTime.getTime(), endTime.getTime());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 进行md5加密,不可逆</span></span><br><span class="line">        String md5 = getMD5(seckillId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">true</span>, md5, seckillId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* queryById 的 sql 实现语句</span></span><br><span class="line"><span class="comment">*/</span>   </span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">"queryById"</span> resultType=<span class="string">"SecKill"</span> parameterType=<span class="string">"long"</span>&gt;</span><br><span class="line">#         use seckill;</span><br><span class="line">        select seckill_id,name,number,start_time,end_time,create_time</span><br><span class="line">        from seckill.seckill</span><br><span class="line">        where seckill_id = #&#123;secKillId&#125;</span><br><span class="line">    &lt;/select&gt;</span><br></pre></td></tr></table></figure>



<p>从代码中可以知道当秒杀开始后，我们进行秒杀时需要去访问数据库获取相应的商品对象，当大量的请求进入系统时，数据库需要承受很高的访问量，而一般的数据库访问速度无法满足秒杀系统这样拥有大量数据操作并且需要快速响应的需求，那么要优化秒杀地址，也就是要优化对数据对象的获取操作</p>
<p><img data-src="https://i.loli.net/2021/02/24/fwPvQ86rHENskiF.png" alt="image-20210224203616945"></p>
<p>这样我们就可以借用 Redis 来高效的完成对数据库的操作。</p>
<p>首先创建 Redis 对应的数据类</p>
<p><img data-src="https://i.loli.net/2021/02/25/gmqpNycr8zUbl5k.png" alt="image-20210225103630762"></p>
<p><code>RedisDao</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.dao.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dyuproject.protostuff.LinkedBuffer;</span><br><span class="line"><span class="keyword">import</span> com.dyuproject.protostuff.ProtostuffIOUtil;</span><br><span class="line"><span class="keyword">import</span> com.dyuproject.protostuff.runtime.RuntimeSchema;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SecKill;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 新建Redis连接池，相当于JDBC的connection</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="keyword">private</span> RuntimeSchema&lt;SecKill&gt; schema = RuntimeSchema.createFrom(SecKill<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisDao</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        jedisPool = <span class="keyword">new</span> JedisPool(ip, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecKill <span class="title">getSeckill</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// redis操作逻辑</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jedis jedis = jedisPool.getResource();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String key = <span class="string">"seckill:"</span> + seckillId;</span><br><span class="line">                <span class="comment">// Jedis 并没有进行内部序列化的操作</span></span><br><span class="line">                <span class="comment">// get -&gt; byte[] -&gt; 反序列化 -&gt; Object(Seckill)</span></span><br><span class="line">                <span class="comment">// 采用自定义序列化</span></span><br><span class="line">                <span class="keyword">byte</span>[] bytes = jedis.get(key.getBytes());</span><br><span class="line">                <span class="comment">// 缓存重获取到</span></span><br><span class="line">                <span class="keyword">if</span> (bytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 创建一个空对象</span></span><br><span class="line">                    SecKill secKill = schema.newMessage();</span><br><span class="line">                    ProtostuffIOUtil.mergeFrom(bytes, secKill, schema);</span><br><span class="line">                    <span class="comment">// seckill 被反序列</span></span><br><span class="line">                    <span class="keyword">return</span> secKill;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">putSeckill</span><span class="params">(SecKill secKill)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// set Object(Seckill) -&gt; 序列化 -&gt; byte[]</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jedis jedis = jedisPool.getResource();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String key = <span class="string">"seckill:"</span> + secKill.getSecKillId();</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = ProtostuffIOUtil.toByteArray(secKill, schema,</span><br><span class="line">                        LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));</span><br><span class="line">                <span class="keyword">int</span> timeout = <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">                String result = jedis.setex(key.getBytes(), timeout, bytes);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对 Spring 的配置文件做修改，添加 RedisDao 对应的 bean 对象</p>
<p><code>spring-dao.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 添加 --&gt;</span>    </span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisDao"</span> <span class="attr">class</span>=<span class="string">"org.seckill.dao.cache.RedisDao"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"localhost"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"6379"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对秒杀地址的方法进行修改，用上 Redis</p>
<p><code>SeckillService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行秒杀操作 by 存储过程</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SeckillException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> RepeatKillException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SeckillCloseException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">SeckillExecution <span class="title">executeSeckillProcedure</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>SeckillServiceIpml</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisDao redisDao;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 优化点：缓存优化,一致性维护基于超时</span></span><br><span class="line">    <span class="comment">// 1：访问 redis，尝试获取 redis 缓存当中的数据对象</span></span><br><span class="line">    SecKill seckill = redisDao.getSeckill(seckillId);</span><br><span class="line">    <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;	<span class="comment">// 未获取到说明 redis 缓存当中没有对应的对象</span></span><br><span class="line">        <span class="comment">// 访问数据库</span></span><br><span class="line">        seckill = secKillDao.queryById(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;	<span class="comment">// 通过 queryById 还是没有获取到，说明 id 在数据库中没有对应</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 添加进redis</span></span><br><span class="line">            String result = redisDao.putSeckill(seckill);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Date startTime = seckill.getStartTime();</span><br><span class="line">    Date endTime = seckill.getEndTime();</span><br><span class="line">    Date nowTime = <span class="keyword">new</span> Date();</span><br><span class="line">    <span class="keyword">if</span> (nowTime.getTime() &lt; startTime.getTime()</span><br><span class="line">            || nowTime.getTime() &gt; endTime.getTime()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId, nowTime.getTime(), startTime.getTime(), endTime.getTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 进行md5加密,不可逆</span></span><br><span class="line">    String md5 = getMD5(seckillId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">true</span>, md5, seckillId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建单元测试，检验逻辑是否正确（结果输出应为代码中注释样）</p>
<p><code>RedisDaoTest</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.seckill.dao.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.seckill.dao.SecKillDao;</span><br><span class="line"><span class="keyword">import</span> org.seckill.entity.SecKill;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OK</span></span><br><span class="line"><span class="comment"> * SecKill&#123;secKillId=1002, name='36元秒杀大米', </span></span><br><span class="line"><span class="comment"> * number=9994, startTime=Sun Jan 17 16:00:00 CST 2021, </span></span><br><span class="line"><span class="comment"> * endTime=Wed Feb 17 16:00:00 CST 2021, </span></span><br><span class="line"><span class="comment"> * createTime=Mon Jan 18 00:50:38 CST 2021&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">@ContextConfiguration("classpath:spring/spring-dao.xml")</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisDaoTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> id = <span class="number">1002</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisDao redisDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecKillDao secKillDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRedisDao</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        SecKill secKill = redisDao.getSeckill(id);</span><br><span class="line">        <span class="keyword">if</span> (secKill == <span class="keyword">null</span>)&#123;</span><br><span class="line">            secKill = secKillDao.queryById(id);</span><br><span class="line">            <span class="keyword">if</span> (secKill != <span class="keyword">null</span>)&#123;</span><br><span class="line">                String result = redisDao.putSeckill(secKill);</span><br><span class="line">                System.out.println(result);</span><br><span class="line">                secKill = redisDao.getSeckill(id);</span><br><span class="line">                System.out.println(secKill);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(secKill);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-4-秒杀操作的优化"><a href="#6-4-秒杀操作的优化" class="headerlink" title="6.4 秒杀操作的优化"></a>6.4 秒杀操作的优化</h2><p><img data-src="https://i.loli.net/2021/02/24/NA67qGwFTQWmfXK.png" alt="image-20210224204007789"></p>
<p>像我们的商品各项信息这种动态更新的东西一般都是没办法使用 CDN 缓存来帮助我们优化访问的，而对于商品数量的操作需要借助于 MySQL 的事务管理来防止数据的不一致情况发生，并且对于某些非常热门的商品，在同一时间可能会有很多的请求进来对数据库的同一行进行操作。这些都是我们可以下手优化的地方。</p>
<p>对于 MySQL 来说，当很多用户访问同一行数据时会发生以下的情况</p>
<p><img data-src="https://i.loli.net/2021/02/24/Yl5Cd3NXM1xDSf6.png" alt="image-20210224204926318"></p>
<p>当一条请求进入到队列时，他会等待上一条请求处理完毕释放所占有的行级锁之后才会执行自己的操作，同样的这条规则适用于队列中所有的请求。这种等待在访问量巨大时，将会成为一个致命的存在。我们优化的方向就是<strong>减少行级锁的持有时间</strong></p>
<p>为了避免因为异地服务器带来的网络延迟问题，我们可以将对 MySQL 数据库的操作放到 MySQL 服务器端去执行，这样可以有效的避免网络延迟而导致的长时间持有行级锁的情况的发生。实现的方法有两种：</p>
<p><img data-src="https://i.loli.net/2021/02/24/f9Z8czOxQEdb2rF.png" alt="image-20210224210325825"></p>
<p><a href="https://www.runoob.com/w3cnote/mysql-stored-procedure.html" target="_blank" rel="noopener">存储过程简单教程</a></p>
<p>创建存储过程</p>
<p><img data-src="https://i.loli.net/2021/02/25/Zm3UR8pIsc47ngk.png" alt="image-20210225105254872"></p>
<p><code>schema.sql</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 秒杀执行存储过程</span></span><br><span class="line">DELIMITER $$ <span class="comment">-- console ; 转换为 $$</span></span><br><span class="line"><span class="comment">-- 定义存储过程</span></span><br><span class="line"><span class="comment">-- 参数：in 输入参数；out 输出参数</span></span><br><span class="line"><span class="comment">-- row_count() : 返回上一条修改类型sql（delete，insert，update）影响的行数</span></span><br><span class="line"><span class="comment">-- row_count() : 0：未修改数据 &gt;0：修改的行数 &lt;0：sql错误、未执行sql</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> seckill.execute_seckill(<span class="keyword">in</span> v_seckill_id <span class="built_in">bigint</span>, <span class="keyword">in</span> v_phone <span class="built_in">bigint</span>,</span><br><span class="line">                                             <span class="keyword">in</span> v_kill_time <span class="built_in">timestamp</span>, <span class="keyword">out</span> r_result <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> insert_count <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line">    <span class="keyword">insert</span> <span class="keyword">ignore</span> <span class="keyword">into</span> success_killed</span><br><span class="line">        (seckill_id, user_phone, create_time)</span><br><span class="line">    <span class="keyword">VALUES</span> (v_seckill_id, v_phone, v_kill_time);</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">row_count</span>() <span class="keyword">into</span> insert_count;</span><br><span class="line">    if (insert_count = 0) then</span><br><span class="line">        <span class="keyword">rollback</span>;</span><br><span class="line">        <span class="keyword">set</span> r_result = <span class="number">-1</span>;</span><br><span class="line">    else</span><br><span class="line">        if (insert_count &lt; 0) then</span><br><span class="line">            <span class="keyword">rollback</span>;</span><br><span class="line">            <span class="keyword">set</span> r_result = <span class="number">-2</span>;</span><br><span class="line">        else</span><br><span class="line">            <span class="keyword">update</span> seckill</span><br><span class="line">            <span class="keyword">set</span> <span class="built_in">number</span> = <span class="built_in">number</span> - <span class="number">1</span></span><br><span class="line">            <span class="keyword">where</span> seckill_id = v_seckill_id</span><br><span class="line">              <span class="keyword">and</span> end_time &gt; v_kill_time</span><br><span class="line">              <span class="keyword">and</span> start_time &lt; v_kill_time</span><br><span class="line">              <span class="keyword">and</span> <span class="built_in">number</span> &gt; <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">select</span> <span class="keyword">ROW_COUNT</span>() <span class="keyword">into</span> insert_count;</span><br><span class="line">            if (insert_count = 0) then</span><br><span class="line">                <span class="keyword">rollback</span>;</span><br><span class="line">                <span class="keyword">set</span> r_result = <span class="number">0</span>;</span><br><span class="line">            elseif (insert_count &lt; 0) then</span><br><span class="line">                <span class="keyword">rollback</span>;</span><br><span class="line">                <span class="keyword">set</span> r_result = <span class="number">-2</span>;</span><br><span class="line">            else</span><br><span class="line">                <span class="keyword">commit</span>;</span><br><span class="line">                <span class="keyword">set</span> r_result = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">$$ <span class="comment">-- 定义结束</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">procedure</span> execute_seckill ;</span><br><span class="line"></span><br><span class="line">DELIMITER ;;</span><br><span class="line"><span class="keyword">set</span> @r_result = <span class="number">-3</span>;</span><br><span class="line"><span class="comment">-- 执行存储过程</span></span><br><span class="line"><span class="keyword">call</span> seckill.execute_seckill(<span class="number">1002</span>,<span class="number">13228217106</span>,<span class="keyword">now</span>(),@r_result);</span><br><span class="line"><span class="comment">-- 获取结果</span></span><br><span class="line"><span class="keyword">select</span> @r_result;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 存储过程</span></span><br><span class="line"><span class="comment">-- 1：存储过程优化：事务行级锁持有的时间</span></span><br><span class="line"><span class="comment">-- 2：不要过度的依赖存储过程</span></span><br><span class="line"><span class="comment">-- 3：简单的逻辑，可以应用存储过程</span></span><br></pre></td></tr></table></figure>

<p>修改 SeckillDao </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用存储过程进行秒杀</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> paramMap</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">killByProcedure</span><span class="params">(Map&lt;String ,Object&gt; paramMap)</span></span>;</span><br></pre></td></tr></table></figure>

<p>添加 Mybatis 配置</p>
<p><code>SecKillDao.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  mybatis调用存储过程  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"killByProcedure"</span> <span class="attr">statementType</span>=<span class="string">"CALLABLE"</span>&gt;</span></span><br><span class="line">        call seckill.execute_seckill(</span><br><span class="line">            #&#123;seckillId,jdbcType=BIGINT,mode=IN&#125;,</span><br><span class="line">            #&#123;phone,jdbcType=BIGINT,mode=IN&#125;,</span><br><span class="line">            #&#123;killTime,jdbcType=TIMESTAMP,mode=IN&#125;,</span><br><span class="line">            #&#123;result,jdbcType=INTEGER,mode=OUT&#125;</span><br><span class="line">            )</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用存储过程进行数据库操作</p>
<p><code>SeckillServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 使用存储过程完成秒杀</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> md5</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> SeckillException</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> RepeatKillException</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> SeckillCloseException</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckillProcedure</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (md5 == <span class="keyword">null</span> || !md5.equals(getMD5(seckillId))) &#123;</span><br><span class="line">          <span class="comment">// 当md5验证失败时，返回数据篡改异常</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.DATA_REWRITE);</span><br><span class="line">      &#125;</span><br><span class="line">      Date killTime = <span class="keyword">new</span> Date();</span><br><span class="line">      Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">      map.put(<span class="string">"seckillId"</span>, seckillId);</span><br><span class="line">      map.put(<span class="string">"phone"</span>, userPhone);</span><br><span class="line">      map.put(<span class="string">"killTime"</span>, killTime);</span><br><span class="line">      map.put(<span class="string">"result"</span>, <span class="keyword">null</span>);</span><br><span class="line">      <span class="comment">// 存储过程执行完毕，result被赋值</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          secKillDao.killByProcedure(map);</span><br><span class="line">          <span class="comment">// 获取result</span></span><br><span class="line">          Integer result = MapUtils.getInteger(map, <span class="string">"result"</span>, -<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">              SuccessKilled sk = successKilledDao.queryByIdWithSecKill(seckillId, userPhone);</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.SUCCESS, sk);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.stateOf(result));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          logger.error(e.getMessage(), e);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>SeckillController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;seckillId&#125;/&#123;md5&#125;/execution"</span>,</span><br><span class="line">        method = RequestMethod.POST,</span><br><span class="line">        produces = &#123;<span class="string">"application/json;charset=UTF-8"</span>&#125;)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SeckillResult&lt;SeckillExecution&gt; <span class="title">execute</span><span class="params">(@PathVariable(<span class="string">"seckillId"</span>)</span> Long seckillId,</span></span><br><span class="line"><span class="function">                                               @<span class="title">PathVariable</span><span class="params">(<span class="string">"md5"</span>)</span> String md5,</span></span><br><span class="line"><span class="function">                                               @<span class="title">CookieValue</span><span class="params">(value = <span class="string">"killPhone"</span>, required = <span class="keyword">false</span>)</span> Long phone) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (phone == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>, <span class="string">"未注册"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    SeckillResult&lt;SeckillExecution&gt; result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 启用存储过程处理</span></span><br><span class="line">        SeckillExecution execution = seckillService.executeSeckillProcedure(seckillId, phone, md5);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">true</span>, execution);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SeckillCloseException e) &#123;</span><br><span class="line">        SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.END);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RepeatKillException e) &#123;</span><br><span class="line">        SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.REPEAT_KILL);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">        SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样进行单元测试</p>
<p><code>SeckillServiceIpmlTest</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输出应为 stateInfo 对应字段，并且当秒杀成功后数据库应有相应变化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeSeckillProcedure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> seckillId = <span class="number">1001</span>;</span><br><span class="line">    <span class="keyword">long</span> phone = <span class="number">13228217109l</span>;</span><br><span class="line">    Exposer exposer = seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">    <span class="keyword">if</span> (exposer.isExposed()) &#123;</span><br><span class="line">        String md5 = exposer.getMd5();</span><br><span class="line">        SeckillExecution execution = seckillService.executeSeckillProcedure(seckillId, phone, md5);</span><br><span class="line">        logger.info(execution.getStateInfo());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此开发完毕</p>
<h1 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h1><p>（先占个位，毕竟这里面涉及到的好多东西都没有搞得非常透彻，写总结也只能写个空空荡荡的。）</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>绯狱丸丶
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://d2372017513.github.io/hexo-test/Projects/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%E5%8F%8A%E6%80%BB%E7%BB%93/" title="秒杀系统开发文档及总结">http://d2372017513.github.io/hexo-test/Projects/秒杀系统开发文档及总结/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/hexo-test/tags/Java/" rel="tag"># Java</a>
              <a href="/hexo-test/tags/Projects/" rel="tag"># Projects</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/hexo-test/Information-Security-Study/Code-Language/Java/%E5%9C%A8Spring-MyBatis%E6%95%B4%E5%90%88%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" rel="prev" title="在Spring + MyBatis整合中遇到的问题">
      <i class="fa fa-chevron-left"></i> 在Spring + MyBatis整合中遇到的问题
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一、工欲善其事，必先利其器"><span class="nav-number">2.</span> <span class="nav-text">一、工欲善其事，必先利其器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-IDEA-的配置"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 IDEA 的配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-Maven-的安装及配置"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 Maven 的安装及配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-使用-IDEA-创建自己的项目并利用-Maven-引入需要的依赖"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 使用 IDEA 创建自己的项目并利用 Maven 引入需要的依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-Mybatis-的配置"><span class="nav-number">2.4.</span> <span class="nav-text">1.4 Mybatis 的配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、秒杀系统业务逻辑梳理"><span class="nav-number">3.</span> <span class="nav-text">二、秒杀系统业务逻辑梳理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-整体业务逻辑梳理"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 整体业务逻辑梳理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-用户层逻辑梳理"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 用户层逻辑梳理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-业务功能的梳理"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 业务功能的梳理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、DAO-层的开发"><span class="nav-number">4.</span> <span class="nav-text">三、DAO 层的开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-数据库设计"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 数据库设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-项目的创建"><span class="nav-number">4.1.1.</span> <span class="nav-text">3.1.1 项目的创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-数据库的创建"><span class="nav-number">4.1.2.</span> <span class="nav-text">3.1.2 数据库的创建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-数据库对应实体的开发"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 数据库对应实体的开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-数据库访问对象-DAO-层的开发"><span class="nav-number">4.3.</span> <span class="nav-text">3.3 数据库访问对象 DAO 层的开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-DAO-层接口的开发"><span class="nav-number">4.3.1.</span> <span class="nav-text">3.3.1 DAO 层接口的开发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-Mybatis-实现-DAO-接口"><span class="nav-number">4.3.2.</span> <span class="nav-text">3.3.2 Mybatis 实现 DAO 接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-Spring-整合-Mybatis"><span class="nav-number">4.4.</span> <span class="nav-text">3.4 Spring 整合 Mybatis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-Spring-的配置"><span class="nav-number">4.4.1.</span> <span class="nav-text">3.4.1 Spring 的配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-单元测试"><span class="nav-number">4.5.</span> <span class="nav-text">3.5 单元测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、SERVICE-的开发"><span class="nav-number">5.</span> <span class="nav-text">四、SERVICE 的开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Service-接口的设计"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 Service 接口的设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Service-层涉及代码编写"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 Service 层涉及代码编写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-Service-接口的实现"><span class="nav-number">5.3.</span> <span class="nav-text">4.3 Service 接口的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-使用-Spring-进行依赖注入"><span class="nav-number">5.4.</span> <span class="nav-text">4.4 使用 Spring 进行依赖注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-进行单元测试"><span class="nav-number">5.5.</span> <span class="nav-text">4.5 进行单元测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、WEB-层的开发"><span class="nav-number">6.</span> <span class="nav-text">五、WEB 层的开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-web-层的设计"><span class="nav-number">6.1.</span> <span class="nav-text">5.1 web 层的设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-SpringMVC-的配置"><span class="nav-number">6.2.</span> <span class="nav-text">5.2 SpringMVC 的配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-使用-SpringMVC-实现-Restful-接口"><span class="nav-number">6.3.</span> <span class="nav-text">5.3 使用 SpringMVC 实现 Restful 接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-使用-bootstrap-开发页面"><span class="nav-number">6.4.</span> <span class="nav-text">5.4 使用 bootstrap 开发页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-Tomcat-的配置和项目的部署"><span class="nav-number">6.5.</span> <span class="nav-text">5.5 Tomcat 的配置和项目的部署</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六、高并发优化"><span class="nav-number">7.</span> <span class="nav-text">六、高并发优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-高并发发生点分析"><span class="nav-number">7.1.</span> <span class="nav-text">6.1 高并发发生点分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-详情页高并发优化"><span class="nav-number">7.2.</span> <span class="nav-text">6.2 详情页高并发优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-秒杀地址优化"><span class="nav-number">7.3.</span> <span class="nav-text">6.3 秒杀地址优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-秒杀操作的优化"><span class="nav-number">7.4.</span> <span class="nav-text">6.4 秒杀操作的优化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#七、总结"><span class="nav-number">8.</span> <span class="nav-text">七、总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="绯狱丸丶"
      src="/hexo-test/images/ouba.jpg">
  <p class="site-author-name" itemprop="name">绯狱丸丶</p>
  <div class="site-description" itemprop="description">DHR‘s Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/hexo-test/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/hexo-test/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/hexo-test/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/d2372017513" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;d2372017513" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/hexo-test/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">绯狱丸丶</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">217k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:17</span>
</div>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/hexo-test/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/hexo-test/lib/velocity/velocity.min.js"></script>
  <script src="/hexo-test/lib/velocity/velocity.ui.min.js"></script>

<script src="/hexo-test/js/utils.js"></script>

<script src="/hexo-test/js/motion.js"></script>


<script src="/hexo-test/js/schemes/pisces.js"></script>


<script src="/hexo-test/js/next-boot.js"></script>

<script src="/hexo-test/js/bookmark.js"></script>




  




  
<script src="/hexo-test/js/local-search.js"></script>













  

  

<script src="/hexo-test/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/hexo-test/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false,"tagMode":false});</script></body>
</html>
<!-- 雪花特效 -->
<script type="text/javascript" src="/hexo-test/js/snow.js"></script>
<!-- 切换页面标题变化-->
<script type = "text/javascript" src = "/hexo-test/js/FunnyTile.js"></script>